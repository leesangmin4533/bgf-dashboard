# Plan: 배송 도착일 기반 예측 (delivery-aware-prediction)

## 1. 문제 정의

### 현재 동작
```
improved_predictor.py line 608:
  target_date = datetime.now() + timedelta(days=1)  # 내일
```

- 2/2(월) 07:00 발주 실행
- target_date = 2/3(화) → **화요일 판매량** 예측
- 실제 도착: 2차 2/4(수) 07:00 / 1차 2/4(수) 20:00
- **화요일 판매에는 이 발주가 쓰이지 않음** (수~목요일 판매용)

### 핵심 불일치

| 항목 | 현재 값 | 올바른 값 |
|------|---------|----------|
| 예측 대상일 | 내일 (today+1) | 도착일 (today+2) |
| 요일계수 | 내일 요일 적용 | 도착일 요일 적용 |
| food_daily_cap | 내일 요일 평균 | 도착일 요일 평균 |
| 안전재고 주석 | "익일배송" | 실제 +2일 |

### 영향 범위
- 요일계수가 1일 어긋남 (금요일 예측인데 토요일 계수 적용 등)
- food_daily_cap이 잘못된 요일 평균 기준으로 적용
- 주류(금/토 급증) 카테고리에서 1일 차이가 큰 오차 유발

---

## 2. BGF 배송 체계 정리 (2026-02-02 확인)

```
발주 실행(D) 07:00  → 시스템 발주
1차 도착: D 당일 20:00 (저녁)
2차 도착: D+1 02:00 (다음날 새벽)
판매 시작: 도착 즉시 판매 가능
```

### 배송 유형별 카테고리

| 배송 유형 | 카테고리 | 중분류 코드 |
|----------|---------|------------|
| 저온 선택발주 | 도시락,주먹밥,김밥,샌드위치,햄버거 | 001-005 |
| 저온 1차 고정 | 빵,떡/모찌,냉장샌드,델리음료,유제품,우유 | 012,013,021,045,046,047 |
| 저온 2차 고정 | 얼음,아이스크림,냉동 | 048 |
| 상온 | 나머지 전부 | 010,기타 |

### 예시: 월요일 07:00 발주

| 시점 | 내용 |
|------|------|
| 월 07:00 | 발주 실행 (target_date = 화요일) |
| 월 20:00 | 1차 도착 → 즉시 판매 (월 저녁 일부 매출) |
| 화 02:00 | 2차 도착 → 즉시 판매 |
| 화 전일 | **주 판매일** (1차+2차 물량 모두 투입) |

### 정리
- 1차/2차 모두 다음날 아침까지 도착 → **주 판매일 = 내일(D+1)**
- `target_date = today + 1` (내일)이 정확
- 배송 유형(저온/상온) 무관하게 동일한 리드타임

---

## 3. 수정 방안

### 방안 A: target_date를 도착일로 변경 (권장)

```python
# 변경 전
target_date = datetime.now() + timedelta(days=1)  # 내일

# 변경 후
# 2차 배송: 모레 아침 도착 → 모레 판매용
# 1차 배송: 모레 저녁 도착 → 글피 판매용
# 대부분의 상품은 모레부터 판매 → target_date = today + 2
target_date = datetime.now() + timedelta(days=2)  # 모레 (도착일)
```

**장점**: 최소 변경, 요일계수가 실제 판매일에 맞음
**단점**: 1차 배송 상품은 실질적으로 D+3부터 판매 (저녁 도착이므로)

### 방안 B: 1차/2차 배송별 분리 예측

```python
# 2차 배송 상품: target_date = today + 2 (모레 아침 도착 → 모레 판매)
# 1차 배송 상품: target_date = today + 3 (모레 저녁 도착 → 글피 판매)
```

**장점**: 배송 차수별 정확한 예측
**단점**: 상품별 배송 차수 정보 필요, 복잡도 증가

### 방안 C: 현행 유지 + 안전재고로 보정

target_date는 그대로 두고, 안전재고 일수를 1일 추가하여 리드타임 보정.

**장점**: 변경 최소
**단점**: 요일계수 불일치 해결 안됨, 근본적 해결 아님

---

## 4. 결론: 코드 변경 불필요 (기존 target_date = today + 1 정확)

### 수정 대상 파일

| 파일 | 변경 내용 | 라인 |
|------|----------|------|
| `src/prediction/improved_predictor.py` | `timedelta(days=1)` → `timedelta(days=2)` | 608 |

### 연쇄 영향 (자동 반영)

변경 없이 자동으로 올바르게 동작하는 부분:
- **요일계수**: target_date.weekday()로 계산 → 도착일 요일 자동 적용
- **food_daily_cap**: target_date 기반 요일 평균 → 도착일 요일 평균 자동 적용
- **안전재고**: 일평균 기반이므로 target_date 변경과 무관
- **재고/미입고 차감**: 현재 시점 재고이므로 무관

### 검증 필요 사항

1. `auto_order.py`의 `get_recommendations()`가 target_date를 predictor에 전달하는 방식
2. `order_executor.py`의 날짜 선택 로직 (BGF order_date와의 관계)
3. `food_daily_cap.py`가 받는 target_date 파라미터
4. `prediction_logs` DB에 저장되는 target_date 의미 변경

### 주의사항

- **BGF order_date는 변경하지 않음** (BGF 시스템의 발주일자는 그대로)
- 변경되는 것은 **예측 대상 판매일**만 (요일계수, cap 계산용)
- `SHELF_LIFE_CONFIG` 주석 "익일배송"을 "발주일+2일 도착"으로 업데이트

---

## 5. 위험 요소

| 위험 | 심각도 | 대응 |
|------|--------|------|
| 요일계수 1일 shift로 예측 정확도 변화 | 중 | A/B 비교 (기존 vs 변경) |
| food_daily_cap이 다른 요일 평균 사용 | 중 | cap 변화량 사전 확인 |
| 기존 prediction_logs와의 일관성 | 저 | target_date 필드가 자동 반영 |
| BGF 시스템 발주일자와 혼동 | 저 | 코드 주석으로 명확화 |

---

## 6. 검증 계획

1. **변경 전**: 현재 예측 결과 스냅샷 저장 (주요 카테고리별)
2. **변경 후**: 동일 데이터로 예측 실행, 차이 비교
3. **핵심 검증 항목**:
   - 주류(049, 050): 금→토 vs 토→일 요일계수 차이
   - 푸드(001~005): food_daily_cap 변화량
   - 전체: 발주 총량 변화율

---

## 7. 구현 범위

### Phase 1: 최소 변경 (1개 파일)
- `improved_predictor.py` line 608: `days=1` → `days=2`
- 주석 업데이트

### Phase 2: 검증 (선택)
- 변경 전/후 예측 결과 비교 스크립트
- 요일계수 shift 영향 분석

### Phase 3: 고도화 (향후)
- 방안 B (1차/2차 분리 예측) 검토
- 상품별 배송 차수 DB 연동
