# Plan: 과자류 예측 개선

## 1. 개요

| 항목 | 내용 |
|------|------|
| Feature | snack-prediction-improvement |
| 작성일 | 2026-02-01 |
| 대상 카테고리 | 015(비스켓/쿠키), 016(스낵류), 019(초콜릿), 020(캔디) |
| 현재 핸들러 | default.py (전용 로직 없음) |
| 목표 | 과자류 발주 정확도 개선 (과잉발주 감소, 품절 방지) |

## 2. 현황 분석

### 2.1 현재 문제점

#### P1. 카테고리 핸들러 미분류 (구조적 문제)

| mid_cd | 카테고리 | 현재 핸들러 | 문제 |
|--------|---------|------------|------|
| 015 | 비스켓/쿠키 | **default.py** | 전용 로직 없음 |
| 016 | 스낵류 | **default.py** | 전용 로직 없음 |
| 019 | 초콜릿 | **default.py** | 전용 로직 없음 |
| 020 | 캔디 | **default.py** | 전용 로직 없음 |

`snack_confection.py`가 존재하지만 `SNACK_CONFECTION_TARGET_CATEGORIES = ["014", "017", "018", "029", "030"]`으로, 주요 과자 카테고리(015/016/019/020)가 **빠져있음**.

- default.py: 유통기한 그룹(ultra_long) + 회전율 multiplier만 적용
- snack_confection.py: 회전율 3단계 안전재고 + 7일 max_stock + DB 학습 요일계수

#### P2. 발주단위 과잉발주

필요량 대비 발주단위가 커서 과잉발주 발생:

```
위너스)프레첼체다치즈: 필요량 3개 → 발주단위 10개 → 발주 10개 (233% 과잉)
```

현재 시스템은 발주단위 올림만 하고, 올림으로 인한 잉여 재고를 다음 발주 판단에 반영하지 않음.

#### P3. 요일 패턴 미반영

실제 데이터 분석 결과:

```
토요일: 계수 1.34 (평일 대비 +34%)
일요일: 계수 0.74 (평일 대비 -26%)
```

그러나 default.py의 과자류 요일계수: `[1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05]`
→ 주말 차이(토 +34%, 일 -26%)를 거의 반영하지 못함.

#### P4. 데이터 부족

| 지표 | 현재값 | 최소 권장 |
|------|--------|----------|
| 평균 데이터 일수 | **5일** | 14일 |
| 수집률 | **60~70%** | 95%+ |
| high confidence 비율 | **35%** | 70%+ |
| 데이터 3일 이하 상품 | **42%** | 10% 미만 |

### 2.2 유사 카테고리 비교

| 카테고리 | 핸들러 | 안전재고 | 요일계수 | max_stock | 특수 로직 |
|---------|--------|---------|---------|-----------|----------|
| 맥주(049) | beer.py | 2.0~3.0일 | DB학습(금토 1.3+) | 7일 | 주말 스파이크 |
| 음료(039등) | beverage.py | 1.5~2.5일 | 주말 1.15 | 7일 | 계절 보정 |
| **과자(015등)** | **default.py** | **1.6~3.0일** | **거의 1.0** | **없음** | **없음** |
| 과자(014등) | snack_confection.py | 1.2~2.0일 | DB학습(~1.05) | 7일 | 회전율 기반 |

## 3. 개선 항목

### 개선 A: 015/016/019/020을 snack_confection.py에 추가

**우선순위: HIGH** | 영향도: 상품 465개 (과자류 전체의 83%)

현재 `SNACK_CONFECTION_TARGET_CATEGORIES`에 4개 카테고리 추가:

```python
# 현재
SNACK_CONFECTION_TARGET_CATEGORIES = ["014", "017", "018", "029", "030"]

# 변경
SNACK_CONFECTION_TARGET_CATEGORIES = ["014", "015", "016", "017", "018", "019", "020", "029", "030"]
```

**효과:**
- 회전율 3단계 안전재고 적용 (고회전 2.0일, 중회전 1.5일, 저회전 1.2일)
- max_stock 7일 상한 적용 → 과잉 재고 방지
- DB 학습 요일계수 적용 가능 (데이터 축적 시)

**위험:**
- 기존 default.py 대비 안전재고가 낮아질 수 있음 (ultra_long 2.0×1.2=2.4일 → snack 1.5일)
- 일시적으로 품절 증가 가능성 → 모니터링 필요

### 개선 B: 요일계수 실측 반영

**우선순위: MEDIUM** | 전제조건: 4주 연속 데이터 확보

snack_confection.py의 DEFAULT_WEEKDAY_COEFS 업데이트:

```python
# 현재 (거의 flat)
"015": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05]

# 실측 기반 개선 (DB 분석 결과 반영)
"015": [0.74, 1.06, 0.99, 1.04, 0.84, 1.01, 1.34]
"016": [0.74, 1.06, 0.99, 1.04, 0.84, 1.01, 1.34]
"019": [0.74, 1.06, 0.99, 1.04, 0.84, 1.01, 1.34]
"020": [0.74, 1.06, 0.99, 1.04, 0.84, 1.01, 1.34]
```

**효과:**
- 토요일 34% 증가 반영 → 토요일 품절 감소
- 일요일 26% 감소 반영 → 일요일 과잉발주 감소

**주의:**
- 현재 데이터 35일(수집률 60%)로는 신뢰도 부족
- 4주 연속 수집 후 재계산 권장
- DB 학습 기능(snack_confection.py 내장)이 자동으로 보정할 수 있으나, 초기값이 중요

### 개선 C: 발주단위 과잉발주 보정

**우선순위: MEDIUM** | 영향도: order_unit_qty > 1인 상품

발주단위 올림으로 인한 잉여 재고를 안전재고에서 차감:

```python
# 현재 (improved_predictor.py)
need_qty = adjusted_prediction + safety_stock - current_stock - pending_qty
order_qty = ceil_to_unit(need_qty, order_unit_qty)

# 개선안: 발주단위가 필요량의 2배 이상이면 안전재고 축소
if order_unit_qty > 1:
    surplus = order_qty - need_qty  # 올림으로 인한 잉여
    if surplus > need_qty:  # 잉여가 필요량보다 크면
        # 다음 발주까지 잉여분이 소진되므로 안전재고 불필요
        adjusted_safety = max(0, safety_stock - surplus)
        need_qty = adjusted_prediction + adjusted_safety - current_stock - pending_qty
        order_qty = ceil_to_unit(need_qty, order_unit_qty)
```

**효과:**
- 프레첼 사례: 필요량 3 → 올림 10 → 잉여 7개가 2.5일분 → 다음 발주 불필요 판단 가능
- 발주단위 큰 상품의 불필요한 연속 발주 방지

### 개선 D: 스파이크 필터링 (이상치 처리)

**우선순위: LOW** | 전제조건: 14일+ 연속 데이터

```
농심)츄파춥스사워바이츠: [1, 1, 6, 1, 1] → 평균 2.0 (6은 이상치)
```

trimmed mean(상하 10% 제거) 또는 median 기반 예측:

```python
# 현재: 단순 평균
base_prediction = mean(recent_sales)

# 개선안: 이상치 제거 평균 (data_days >= 7일 때만)
if data_days >= 7:
    sorted_sales = sorted(recent_sales)
    trim = max(1, len(sorted_sales) // 10)  # 상하 10%
    base_prediction = mean(sorted_sales[trim:-trim])
```

**효과:**
- 묶음구매, 행사 등 일시적 스파이크 영향 감소
- 안정적인 기저 수요 추정

## 4. 구현 계획

### 변경 파일

| 파일 | 개선 | 변경 내용 |
|------|------|----------|
| `src/prediction/categories/snack_confection.py` | A, B | TARGET_CATEGORIES 확장, 요일계수 업데이트 |
| `src/prediction/improved_predictor.py` | C, D | 발주단위 보정, 이상치 필터 |

### 변경하지 않는 파일

| 파일 | 이유 |
|------|------|
| `src/prediction/categories/default.py` | 015/016/019/020이 snack_confection으로 이동하면 자동으로 사용 안됨 |
| `src/order/auto_order.py` | 발주 실행 로직 변경 없음 |
| `src/prediction/pre_order_evaluator.py` | 사전 평가 로직 변경 없음 |
| `src/db/models.py` | 스키마 변경 없음 |

### 단계별 실행

| 단계 | 개선 | 위험도 | 전제조건 |
|------|------|:------:|---------|
| **1단계** | A. 카테고리 핸들러 분류 | 낮음 | 없음 (즉시 가능) |
| **2단계** | B. 요일계수 실측 반영 | 중간 | A 완료 |
| **3단계** | C. 발주단위 과잉발주 보정 | 중간 | 없음 (독립) |
| **4단계** | D. 스파이크 필터링 | 낮음 | 14일+ 데이터 |

## 5. 검증 방법

### 모의발주 비교 (개선 전/후)

```bash
# 개선 전 모의발주 저장 (이미 완료)
# test report/dry_order_20260201_101419.xlsx

# 개선 후 모의발주
python scripts/dry_order.py --no-login --no-pending

# 비교 항목:
# - 과자류(015/016/019/020) 총 발주량 변화
# - 상품별 발주량 증감
# - 발주 상품 수 변화
```

### 핵심 검증 지표

| 지표 | 개선 전 | 목표 |
|------|--------|------|
| 과자류 총 발주량 | 303개 (015:84 + 016:116 + 019:115 + 020:203) | 10~20% 감소 |
| 발주단위 과잉발주 건수 | 미측정 | 50% 감소 |
| max_stock 초과 상품 | 제한 없음 | 0개 |

### DB 기반 사후 검증 (2~4주 후)

```sql
-- 과자류 품절율 변화 (개선 전/후 비교)
SELECT mid_cd,
    ROUND(AVG(CASE WHEN stock_qty = 0 THEN 1.0 ELSE 0.0 END) * 100, 1) as stockout_pct
FROM daily_sales
WHERE mid_cd IN ('015','016','019','020')
  AND sales_date >= date('now', '-14 days')
GROUP BY mid_cd;
```

## 6. 롤백 계획

개선 A (카테고리 분류)가 문제 발생 시:
- `SNACK_CONFECTION_TARGET_CATEGORIES`에서 015/016/019/020 제거
- 즉시 default.py로 복귀 (코드 1줄 변경)

## 7. 데이터 수집 안정화 (병행 과제)

코드 개선과 별개로, 예측 정확도의 근본 전제:

| 항목 | 현재 | 목표 | 방법 |
|------|------|------|------|
| 일일 수집률 | 60~70% | 95%+ | 스케줄러 안정성 확인, 실패 시 재시도 |
| 연속 데이터 | 평균 5일 | 14일+ | 4주 안정 운영 |
| high confidence | 35% | 70%+ | 수집 연속성 확보로 자연 달성 |

이 과제는 별도 PDCA로 관리하되, 개선 B(요일계수)와 D(스파이크 필터)의 전제조건임.
