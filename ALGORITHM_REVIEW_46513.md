# 호반점(46513) 예측 알고리즘 개선 필요 사항 검토

**검토일**: 2026-02-07
**대상 점포**: 46513 (이천호반베르디움점)
**분석 기간**: 최근 30일 (2026-01-08 ~ 2026-02-07)
**총 평가 건수**: 14,715건 (검증 완료: 13,091건, 88.9%)

---

## 📊 전체 성과 요약

### 긍정적 지표 ✅
- **평균 절대 오차 (MAE)**: 0.75개 - 양호한 수준
- **폐기율**: 0.08% (10건/13,091건) - 매우 낮음 (우수)
- **검증률**: 88.9% - 사후 검증 잘 진행됨

### 개선 필요 지표 ⚠️
- **품절률**: 16.68% (2,183건/13,091건) - **높음, 개선 필요**
- **MSE**: 356.67 - 일부 극단적 오차 존재

---

## 🚨 긴급 개선 필요 사항

### 1. 소모품(900) 카테고리 - 치명적 과다 예측

**문제 심각도**: 🔴 **CRITICAL**

#### 현황
| 상품 코드 | 평가 횟수 | 실제 평균 판매 | 예측 평균 | MAE | 과다 예측 배수 |
|----------|----------|--------------|----------|-----|---------------|
| 2201148653150 | 8건 | 11.5개 | 470.25개 | 473.0 | **42배** |
| 2202000037309 | 8건 | 7.0개 | 0.00개 | 7.0 | 과소 예측 |

**종합 지표**:
- MAE: 240.00 (카테고리 평균 0.75의 **320배**)
- 품절률: 50% (전체 평균 16.68%의 3배)

#### 원인 분석
1. **알고리즘 버그 의심**: 470개 예측은 비정상적 수치
2. **카테고리 라우팅 문제**: 소모품(900)이 잘못된 예측 모듈 사용 가능성
3. **일평균 계산 오류**: 실제 11.5개를 470개로 예측하는 것은 계산 로직 문제

#### 긴급 조치 필요
```python
# 1. 소모품(900) 카테고리가 어느 예측 모듈을 사용하는지 확인
# 파일: src/prediction/improved_predictor.py
# - default.py 사용 중인지 확인
# - 카테고리별 라우팅 로직 검증

# 2. 상품 2201148653150의 prediction_logs 상세 조회
SELECT prediction_date, predicted_qty, daily_avg, weekday_factor,
       safety_stock, current_stock, pending_qty
FROM prediction_logs
WHERE item_cd = '2201148653150'
AND store_id = '46513'
ORDER BY prediction_date DESC
LIMIT 10;

# 3. 임시 조치: 소모품 카테고리 최대 발주량 상한 설정
# config/prediction_config.py에 max_order_qty 추가
```

---

### 2. 푸드류 - 심각한 품절 문제

**문제 심각도**: 🔴 **HIGH**

#### 카테고리별 품절률 (최근 30일)

| 순위 | 카테고리 | 평가 횟수 | 품절률 | 실제 평균 판매 | 예측 평균 | MAE |
|-----|---------|----------|--------|--------------|----------|-----|
| 1 | **주먹밥(002)** | 266건 | **94.74%** | 0.42개 | 0.20개 | 0.48 |
| 2 | **샌드위치(004)** | 103건 | **91.26%** | 0.31개 | 0.22개 | 0.46 |
| 3 | **김밥(003)** | 133건 | **80.45%** | 0.33개 | 0.22개 | - |
| 4 | **도시락(001)** | 110건 | **80.00%** | 0.32개 | 0.25개 | - |
| 5 | 햄버거(005) | 76건 | 71.05% | 0.39개 | 0.13개 | - |
| 6 | 빵(012) | 299건 | 51.51% | 0.68개 | 0.13개 | - |

**전체 평균 품절률 16.68% 대비 5~6배 높음**

#### 주먹밥(002) 상세 분석 (2026-02-06 실제 데이터)

**패턴 발견**:
- **재고 0개 + FORCE_ORDER** → 품절 발생 (10건/20건)
- **재고 1개 + PASS** → 판매 1개 발생 시 품절 (4건/20건)
- **predicted_qty가 NULL인 경우 많음** → 발주 안 함

```
예시 케이스:
- 상품: 8801771035565 (daily_avg: 2.67)
  - 재고: 0개, 예측: 1개, 실제 판매: 1개 → 품절 (재고 부족)

- 상품: 8800336392143 (daily_avg: 0.86)
  - 재고: 1개, 예측: NULL (발주 안 함), 실제 판매: 1개 → 품절
```

#### 원인 분석

1. **과소 발주 문제**
   - daily_avg가 0.42~2.67개로 낮게 계산됨
   - 예측량이 0.20개로 실제보다 절반 수준

2. **안전재고 부족**
   - 현재 재고: 평균 0.26개 (0 또는 1개)
   - 1개 판매 시 즉시 품절 발생

3. **발주 스킵 문제**
   - `predicted_qty = NULL`인 경우 다수 (PASS 결정)
   - 재고 1개인데 발주 안 하면 판매 1개 시 품절

4. **유통기한 짧은 특성 미반영**
   - 주먹밥 유통기한: 1일
   - 보수적 발주로 인한 과소 발주

#### 개선 방안

**즉시 적용 가능한 조치**:

```python
# 1. 푸드류 안전재고 상향 (food.py 수정)
# 현재: safety_stock = max(1, int(daily_avg * expiry_days * 0.5))
# 개선: safety_stock = max(2, int(daily_avg * expiry_days * 0.7))

# 2. 최소 발주량 보장
# 현재: daily_avg < 0.5이면 발주 안 할 수 있음
# 개선: 푸드류는 최소 1개 발주 (재고 0일 때)

# 3. 품절 빈도 높은 상품 긴급 발주 강화
# stockout_freq > 0.5 → FORCE_ORDER로 전환
```

**파라미터 조정**:

```json
// config/stores/46513_eval_params.json
{
  "exposure_urgent": {
    "value": 1.0,  // → 1.5로 상향 (긴급 발주 더 자주)
  },
  "exposure_normal": {
    "value": 2.0,  // → 1.5로 하향 (일반 발주 더 자주)
  },
  "stockout_freq_threshold": {
    "value": 0.25,  // → 0.20으로 하향 (더 빨리 업그레이드)
  }
}
```

---

### 3. 기타 품절률 높은 카테고리

#### 고품절률 카테고리 (상위 10)

| 순위 | 카테고리 | 품절률 | 평가 횟수 | MAE |
|-----|---------|--------|----------|-----|
| 1 | 와인(053) | 54.84% | 31건 | 0.48 |
| 2 | 액세서리(059) | 36.84% | 19건 | 0.58 |
| 3 | 신선과일(046) | 24.28% | 173건 | 0.66 |
| 4 | 빵(047) | 24.16% | 298건 | 0.76 |
| 5 | 즉석국탕(028) | 20.00% | 95건 | 0.58 |
| 6 | 액세서리(057) | 19.05% | 189건 | 0.84 |

**공통 패턴**:
- 저회전 상품 또는 신선 상품
- 안전재고 부족
- 과소 예측 경향

---

## 📈 비교적 양호한 카테고리

| 카테고리 | 품절률 | 평가 횟수 | MAE | 특징 |
|---------|--------|----------|-----|------|
| 빵(051) | 0.00% | 94건 | 0.46 | ✅ 우수 |
| 과자(048) | 0.00% | 55건 | 0.53 | ✅ 우수 |
| 세면용품(036) | 1.28% | 78건 | 0.54 | ✅ 우수 |
| 소주(050) | 1.64% | 122건 | 1.34 | 양호 |
| 탄산음료(044) | 2.69% | 484건 | 0.69 | 양호 |
| 맥주(049) | 4.13% | 412건 | 1.25 | 양호 |

**성공 요인**:
- 회전율 높고 안정적 수요
- 유통기한 긴 상품
- 요일 패턴 명확

---

## 🔧 알고리즘 개선 우선순위

### Priority 1 (긴급) - 이번 주 내 수정

#### 1.1 소모품(900) 버그 수정 🔴
```python
# 파일: src/prediction/categories/default.py
# 또는 src/prediction/improved_predictor.py

# 문제: 상품 2201148653150 예측 470개 (실제 11.5개)
# 조치:
# 1. 소모품 카테고리 최대 발주량 상한 설정
MAX_ORDER_QTY_BY_CATEGORY = {
    "900": 20,  # 소모품: 최대 20개
    # ...
}

# 2. 예측 로직 검증
if mid_cd == "900":
    # 일평균 * 요일계수 * 1.2 정도로 제한
    predicted = min(predicted, daily_avg * weekday_factor * 1.5)
    predicted = min(predicted, 20)  # 절대 상한
```

#### 1.2 푸드류 안전재고 상향 🔴
```python
# 파일: src/prediction/categories/food.py

# 현재 (추정)
safety_stock = max(1, int(daily_avg * expiry_days * 0.5))

# 개선
safety_stock = max(2, int(daily_avg * expiry_days * 0.7))

# 또는 품절 빈도 기반 추가
if stockout_freq > 0.5:  # 최근 50% 이상 품절
    safety_stock = int(safety_stock * 1.5)  # 1.5배 증가
```

#### 1.3 최소 발주량 보장
```python
# 파일: src/prediction/improved_predictor.py

# 푸드류 최소 발주량 로직
if mid_cd in FOOD_CATEGORIES:
    if current_stock == 0 and daily_avg > 0.3:
        # 재고 0이고 판매 이력 있으면 최소 1개 발주
        order_qty = max(1, order_qty)
```

---

### Priority 2 (중요) - 다음 주 내 수정

#### 2.1 품절 상품 긴급 발주 강화
```python
# 파일: src/prediction/pre_order_evaluator.py

# 품절 빈도 높은 상품 자동 업그레이드
if stockout_freq > 0.3:  # 현재 0.25 → 0.3으로 완화
    decision = "URGENT_ORDER"  # NORMAL → URGENT 강제 전환
```

#### 2.2 카테고리별 발주량 상하한 설정
```python
# 파일: config/prediction_config.py

CATEGORY_ORDER_LIMITS = {
    "900": {"min": 0, "max": 20},      # 소모품
    "001": {"min": 1, "max": 10},      # 도시락
    "002": {"min": 1, "max": 15},      # 주먹밥
    "003": {"min": 1, "max": 10},      # 김밥
    "004": {"min": 1, "max": 8},       # 샌드위치
    "012": {"min": 1, "max": 20},      # 빵
    # ...
}
```

---

### Priority 3 (개선) - 2주 내 검토

#### 3.1 요일별 패턴 학습 강화
```python
# 주먹밥, 도시락 등 요일 패턴 명확한 카테고리
# 최근 4주 동일 요일 데이터로 예측 정확도 향상
```

#### 3.2 품절 예측 모델 추가
```python
# 품절 위험도 계산 후 사전 발주량 증가
stockout_risk_score = (
    stockout_freq * 0.5 +
    (1 - current_stock / daily_avg) * 0.3 +
    recent_trend * 0.2
)

if stockout_risk_score > 0.7:
    order_qty += int(daily_avg * 0.3)  # 30% 추가 발주
```

---

## 📋 코드 수정 체크리스트

### 긴급 (이번 주)
- [ ] `src/prediction/categories/default.py` - 소모품(900) 최대 발주량 상한 추가
- [ ] `src/prediction/categories/food.py` - 안전재고 계수 0.5 → 0.7
- [ ] `src/prediction/improved_predictor.py` - 푸드류 최소 발주량 1개 보장
- [ ] 소모품 예측 버그 원인 파악 (상품 2201148653150)

### 중요 (다음 주)
- [ ] `src/prediction/pre_order_evaluator.py` - 품절 빈도 임계값 0.25 → 0.30
- [ ] `config/prediction_config.py` - 카테고리별 발주량 상하한 딕셔너리 추가
- [ ] `config/stores/46513_eval_params.json` - exposure_urgent/normal 조정

### 개선 (2주 내)
- [ ] 요일별 학습 로직 개선
- [ ] 품절 위험도 스코어 추가

---

## 🎯 기대 효과

### 개선 목표 (4주 후)

| 지표 | 현재 | 목표 | 개선률 |
|------|------|------|--------|
| 전체 품절률 | 16.68% | **10% 이하** | -40% |
| 주먹밥 품절률 | 94.74% | **50% 이하** | -47% |
| 샌드위치 품절률 | 91.26% | **50% 이하** | -45% |
| 소모품 MAE | 240.00 | **2.0 이하** | -99% |
| 전체 MAE | 0.75 | **0.60 이하** | -20% |
| 폐기율 | 0.08% | **0.15% 이하** | 유지 |

**트레이드오프 고려**:
- 품절률 감소 → 폐기율 소폭 증가 예상 (0.08% → 0.15%)
- 목표: 품절률 40% 감소, 폐기율 2배 증가 허용 (여전히 낮은 수준)

---

## 📊 모니터링 지표

### 일일 체크 (자동)
```sql
-- 1. 카테고리별 품절률 (일일)
SELECT mid_cd,
       ROUND(100.0 * SUM(was_stockout) / COUNT(*), 2) as stockout_rate
FROM eval_outcomes
WHERE store_id = '46513'
AND eval_date = date('now', '-1 day')
AND actual_sold_qty IS NOT NULL
GROUP BY mid_cd
HAVING stockout_rate > 20
ORDER BY stockout_rate DESC;

-- 2. 소모품 이상 예측 탐지
SELECT item_cd, predicted_qty, actual_sold_qty,
       ABS(predicted_qty - actual_sold_qty) as error
FROM eval_outcomes
WHERE store_id = '46513'
AND mid_cd = '900'
AND eval_date >= date('now', '-7 days')
AND predicted_qty > 50
ORDER BY error DESC;
```

### 주간 리뷰
- 푸드류 품절률 추이 (목표: 주차별 5% 감소)
- 소모품 예측 오차 추이 (목표: MAE < 5)
- 전체 폐기율 추이 (목표: < 0.2%)

---

## 🔍 추가 조사 필요 사항

1. **ImprovedPredictor에 store_id 파라미터 누락**
   - Phase 2에서 추가했어야 했으나 누락
   - Phase 3 보완에서 추가 필요

2. **prediction_logs의 avg_stock이 음수**
   - 최근 7일 평균: -0.44개
   - 재고 계산 로직 점검 필요

3. **소모품(900) 예측 모듈 확인**
   - 어떤 카테고리 파일을 사용하는가?
   - default.py인가, 별도 모듈인가?

---

**검토자**: AI Assistant
**최종 업데이트**: 2026-02-07 17:00 KST
**다음 검토 예정**: 2026-02-14 (1주 후, 긴급 수정 적용 후)
