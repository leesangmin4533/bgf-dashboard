{% extends "base.html" %}

{% block title %}{{ cat_name }} 카테고리 분석 - {{ mid_cd }}{% endblock %}
{% block header %}{{ cat_name }} 카테고리 심층 분석{% endblock %}
{% block subtitle %}중분류 코드: {{ mid_cd }} | {{ generated_at }} 생성{% endblock %}

{% block content %}
<!-- 개요 카드 -->
<div class="card-grid">
    <div class="card">
        <div class="value">{{ overview.item_count }}</div>
        <div class="label">판매 상품수 (30일)</div>
    </div>
    <div class="card accent">
        <div class="value">{{ overview.total_sales | number_format }}</div>
        <div class="label">총 판매량 (30일)</div>
    </div>
    <div class="card">
        <div class="value">{{ overview.daily_avg }}</div>
        <div class="label">일평균 판매량</div>
    </div>
    <div class="card">
        <div class="value">{{ overview.avg_per_item }}</div>
        <div class="label">상품당 일평균</div>
    </div>
    <div class="card">
        <div class="value">{{ overview.data_days }}일</div>
        <div class="label">데이터 기간</div>
    </div>
</div>

<!-- 요일 계수 비교 -->
<div class="section">
    <h2 class="section-title">요일 계수 비교 (설정값 vs 기본값)</h2>
    <div class="chart-box">
        <canvas id="weekdayChart" height="280"></canvas>
    </div>
</div>

<!-- 회전율 분포 -->
<div class="section">
    <h2 class="section-title">회전율 분포</h2>
    <div style="display:flex; gap:2rem; align-items:center; flex-wrap:wrap;">
        <div style="width:280px; height:280px;">
            <canvas id="turnoverChart"></canvas>
        </div>
        <div>
            {% for i in range(turnover_dist.labels | length) %}
            <div style="margin-bottom:0.5rem;">
                <span style="display:inline-block;width:14px;height:14px;border-radius:3px;vertical-align:middle;
                    background:{{ ['#22c55e','#eab308','#ef4444'][i] }};"></span>
                <span style="margin-left:0.5rem;">{{ turnover_dist.labels[i] }}: <strong>{{ turnover_dist.counts[i] }}</strong>개</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 상품별 7일 Sparkline -->
{% if sparklines %}
<div class="section">
    <h2 class="section-title">상품별 7일 판매 추이 (상위 {{ sparklines | length }}개)</h2>
    <input type="text" id="sparkSearch" class="search-box" placeholder="상품명 검색...">
    <div class="table-wrapper">
        <div class="table-scroll">
            <table id="sparkTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th data-sort="text">상품명</th>
                        <th data-sort="num" class="text-right">합계</th>
                        <th data-sort="num" class="text-right">일평균</th>
                        <th>7일 추이</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in sparklines %}
                    <tr>
                        <td class="text-center">{{ loop.index }}</td>
                        <td title="{{ item.item_cd }}">{{ item.item_nm }}</td>
                        <td class="text-right" style="font-weight:600;">{{ item.total | number_format }}</td>
                        <td class="text-right">{{ item.avg }}</td>
                        <td>
                            <div class="spark-bar">
                                {% for val in item.data %}
                                <div class="spark-col"
                                     style="height:{{ (val / [item.max_val, 1] | max * 100) | round }}%;"
                                     title="{{ val }}">
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- 안전재고 설정 정보 -->
<div class="section">
    <h2 class="section-title">안전재고 설정 정보</h2>
    <div style="display:flex; gap:2rem; flex-wrap:wrap;">
        <div style="flex:1; min-width:300px;">
            <h3 style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">유통기한 그룹별 안전일수</h3>
            <table>
                <thead>
                    <tr>
                        <th>그룹</th>
                        <th class="text-right">유통기한 범위</th>
                        <th class="text-right">안전일수</th>
                    </tr>
                </thead>
                <tbody>
                {% for s in safety_config.shelf_life %}
                    <tr>
                        <td>{{ s.group }}</td>
                        <td class="text-right">{{ s.range }}일</td>
                        <td class="text-right" style="font-weight:600;">{{ s.safety_days }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="flex:1; min-width:300px;">
            <h3 style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">회전율별 배수</h3>
            <table>
                <thead>
                    <tr>
                        <th>회전율</th>
                        <th class="text-right">기준 (일평균)</th>
                        <th class="text-right">배수</th>
                    </tr>
                </thead>
                <tbody>
                {% for t in safety_config.turnover %}
                    <tr>
                        <td>{{ t.level }}</td>
                        <td class="text-right">{{ t.min_daily }}+</td>
                        <td class="text-right" style="font-weight:600;">x{{ t.multiplier }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.spark-bar {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 30px;
    min-width: 80px;
}
.spark-col {
    flex: 1;
    min-width: 6px;
    background: var(--accent);
    border-radius: 2px 2px 0 0;
    min-height: 2px;
    transition: background 0.2s;
}
.spark-col:hover {
    background: var(--warning);
}
</style>
<script>
var _g = getComputedStyle(document.documentElement);
var _gridC = _g.getPropertyValue('--chart-grid').trim();
var _bgBase = _g.getPropertyValue('--bg-base').trim();

// 요일 계수 비교 (Radar)
const weekdayLabels = {{ weekday_coefs.labels | to_json }};
const configCoefs = {{ weekday_coefs.config | to_json }};
const defaultCoefs = {{ weekday_coefs.default | to_json }};

new Chart(document.getElementById('weekdayChart'), {
    type: 'radar',
    data: {
        labels: weekdayLabels,
        datasets: [
            {
                label: '설정값 ({{ cat_name }})',
                data: configCoefs,
                borderColor: 'var(--text-primary, #fafafa)',
                backgroundColor: 'rgba(250,250,250,0.1)',
                pointBackgroundColor: 'var(--text-primary, #fafafa)',
                borderWidth: 2,
            },
            {
                label: '기본값',
                data: defaultCoefs,
                borderColor: '#999999',
                backgroundColor: 'rgba(153,153,153,0.08)',
                pointBackgroundColor: '#999999',
                borderWidth: 2,
                borderDash: [5, 5],
            }
        ]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: {
            r: {
                grid: { color: _gridC },
                angleLines: { color: _gridC },
                pointLabels: { font: { size: 13 } },
                ticks: { display: false },
                beginAtZero: true,
            }
        }
    }
});

// 회전율 분포 (Doughnut)
new Chart(document.getElementById('turnoverChart'), {
    type: 'doughnut',
    data: {
        labels: {{ turnover_dist.labels | to_json }},
        datasets: [{
            data: {{ turnover_dist.counts | to_json }},
            backgroundColor: ['#22c55e', '#eab308', '#ef4444'],
            borderColor: _bgBase,
            borderWidth: 3,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: '55%',
        plugins: {
            legend: { display: false },
        }
    }
});

initTableSearch('sparkSearch', 'sparkTable');
initTableSort('sparkTable');
</script>
{% endblock %}
