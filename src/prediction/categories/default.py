"""
일반 상품 카테고리 예측 모듈

특정 카테고리에 해당하지 않는 일반 상품의 안전재고 계산:
- 유통기한 기반 기본 안전재고 일수
- 회전율 기반 조정
- 요일별 계수

공식: 일평균 × 안전재고일수 × 회전율배수
"""

from dataclasses import dataclass
from typing import Optional


# =============================================================================
# 유통기한별 설정
# =============================================================================
SHELF_LIFE_CONFIG = {
    # 유통기한 그룹: (최소일, 최대일, 안전재고_일수, 폐기율)
    "ultra_short": {  # 초단기: 1-3일 (도시락, 김밥, 샌드위치)
        "min_days": 1,
        "max_days": 3,
        "safety_stock_days": 0.3,  # 0.3일치 (매일발주+익일배송 환경)
        "disuse_rate": 0.024,      # 2.4% 폐기율 (실측)
        "order_freq": "daily",     # 매일 발주
    },
    "short": {  # 단기: 4-7일 (우유, 빵)
        "min_days": 4,
        "max_days": 7,
        "safety_stock_days": 0.5,  # 0.5일치
        "disuse_rate": 0.001,
        "order_freq": "daily",
    },
    "medium": {  # 중기: 8-30일 (요구르트, 디저트)
        "min_days": 8,
        "max_days": 30,
        "safety_stock_days": 0.7,  # 0.7일치 (매일발주+익일배송 환경)
        "disuse_rate": 0.003,
        "order_freq": "every_other",  # 격일 발주 가능
    },
    "long": {  # 장기: 31-90일 (과자, 음료)
        "min_days": 31,
        "max_days": 90,
        "safety_stock_days": 1.0,  # 1.0일치 (매일발주+익일배송 환경)
        "disuse_rate": 0.0,
        "order_freq": "weekly",
    },
    "ultra_long": {  # 초장기: 91일+ (라면, 통조림)
        "min_days": 91,
        "max_days": 9999,
        "safety_stock_days": 1.0,  # 1.0일치 (매일발주+익일배송 환경)
        "disuse_rate": 0.0,
        "order_freq": "weekly",
    },
}


# =============================================================================
# 카테고리별 요일 계수 (실제 31일 데이터 기반)
# =============================================================================
# 1.0 = 평균, 1.2 = 평균 대비 20% 증가
WEEKDAY_COEFFICIENTS = {
    # mid_cd: [일, 월, 화, 수, 목, 금, 토]

    # === 주류 (금/토 급증) ===
    "049": [0.97, 1.15, 1.22, 1.21, 1.37, 2.54, 2.37],  # 맥주
    "050": [0.91, 0.90, 1.06, 1.16, 1.55, 1.88, 2.14],  # 소주
    "051": [1.00, 1.00, 1.00, 1.00, 1.00, 1.30, 1.50],  # 전통주 (추정)
    "605": [1.00, 1.00, 1.00, 1.00, 1.00, 1.30, 1.40],  # 기타주류 (추정)

    # === 담배류 (금/토 증가) ===
    "072": [1.24, 0.99, 1.15, 1.21, 1.24, 1.44, 1.47],  # 담배
    "073": [1.10, 1.06, 1.06, 1.56, 1.68, 2.01, 2.18],  # 전자담배

    # === 즉석식품 (평일 안정) ===
    "001": [1.04, 0.98, 1.06, 0.98, 0.98, 0.98, 0.98],  # 도시락
    "002": [0.99, 1.02, 1.04, 0.98, 0.98, 1.02, 0.96],  # 주먹밥
    "003": [1.02, 1.01, 0.97, 0.97, 1.03, 1.03, 0.97],  # 김밥
    "004": [0.98, 0.98, 0.98, 0.98, 0.98, 0.98, 1.09],  # 샌드위치
    "032": [1.00, 1.16, 1.19, 1.23, 1.22, 1.39, 1.67],  # 면류

    # === 음료 (주말 증가) ===
    "044": [1.01, 0.81, 1.27, 1.36, 1.43, 1.44, 1.80],  # 탄산음료
    "040": [1.00, 1.00, 1.00, 1.00, 1.00, 1.10, 1.20],  # 기능건강음료
    "041": [1.00, 1.00, 1.00, 1.00, 1.00, 1.10, 1.15],  # 생수
    "042": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.10],  # 커피음료
    "047": [1.04, 1.04, 1.37, 1.02, 1.11, 1.47, 1.49],  # 우유

    # === 과자류 (토요일 증가) ===
    "016": [1.01, 0.90, 0.99, 1.05, 0.97, 0.97, 1.11],  # 스낵류
    "015": [0.94, 1.04, 1.08, 1.07, 0.94, 1.01, 0.92],  # 비스켓/쿠키
    "019": [1.10, 0.93, 1.05, 0.98, 0.84, 1.05, 1.05],  # 초콜릿
    "020": [1.01, 1.09, 0.99, 1.00, 0.86, 1.08, 0.97],  # 캔디

    # === 기타 (기존) ===
    "023": [0.93, 0.94, 1.20, 1.06, 0.95, 0.98, 0.94],  # 육가공류
    "022": [0.98, 1.20, 0.95, 0.89, 0.93, 0.95, 1.08],  # 마른안주류
    "060": [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00],  # 홈/주방용품
    "900": [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00],  # 소모품

    # === 소멸성 상품 ===
    "013": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 떡
    "026": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 과일/채소
    "046": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 요구르트

    # === 음료류 ===
    "010": [1.00, 0.95, 0.95, 1.00, 1.00, 1.15, 1.10],  # 제조음료
    "039": [1.00, 0.95, 0.95, 1.00, 1.00, 1.15, 1.10],  # 과일야채음료
    "043": [1.00, 0.95, 0.95, 1.00, 1.00, 1.15, 1.10],  # 차음료
    "045": [1.00, 0.95, 0.95, 1.00, 1.00, 1.15, 1.10],  # 아이스드링크
    "048": [1.00, 0.95, 0.95, 1.00, 1.00, 1.20, 1.15],  # 얼음

    # === 냉동/아이스크림 ===
    "021": [1.40, 0.90, 0.90, 0.95, 1.00, 1.30, 1.40],  # 일반아이스크림
    "034": [1.00, 1.00, 1.00, 1.00, 1.00, 1.10, 1.05],  # 냉동즉석식
    "100": [1.40, 0.90, 0.90, 0.95, 1.00, 1.30, 1.40],  # RI아이스크림

    # === 즉석식품 ===
    "027": [1.00, 1.00, 1.05, 1.05, 1.00, 0.95, 0.95],  # 농산식재료
    "028": [1.00, 1.00, 1.05, 1.05, 1.00, 0.95, 0.95],  # 축수산식재료
    "031": [1.00, 1.00, 1.05, 1.05, 1.00, 0.95, 0.95],  # 반찬류
    "033": [1.00, 1.00, 1.05, 1.05, 1.00, 0.95, 0.95],  # 상온즉석식
    "035": [1.00, 1.00, 1.05, 1.05, 1.00, 0.95, 0.95],  # 냉장즉석식

    # === 과자/간식/디저트 ===
    "014": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 디저트
    "017": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 시리얼
    "018": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 껌
    "029": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 조미료류
    "030": [1.00, 1.00, 1.00, 1.00, 1.00, 1.05, 1.05],  # 커피차류

    # === 일반주류 ===
    "052": [1.00, 0.80, 0.80, 0.85, 1.10, 1.50, 2.00],  # 양주
    "053": [1.00, 0.80, 0.80, 0.85, 1.10, 1.50, 2.00],  # 와인

    # === 생활용품 ===
    "036": [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00],  # 의약외품
    "037": [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00],  # 건강기능
    "056": [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00],  # 목욕세면
    "057": [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00],  # 위생용품
    "086": [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00],  # 안전상비의약품
}

# 기본 요일 계수 (매핑 없는 카테고리용)
DEFAULT_WEEKDAY_COEFFICIENTS = [1.00, 0.95, 1.00, 1.00, 0.95, 1.05, 1.10]


# =============================================================================
# 안전재고 설정
# =============================================================================
# 일평균 판매량 대비 안전재고 배수
SAFETY_STOCK_MULTIPLIER = {
    # 고회전 상품 (일평균 5개 이상): 매일발주로 보충 가능
    "high_turnover": {
        "min_daily_avg": 5.0,
        "multiplier": 1.0,  # 1.0배 (매일발주+익일배송으로 충분)
        "categories": ["900", "060", "049", "073"],  # 소모품, 홈용품, 맥주, 전자담배
    },
    # 중회전 상품 (일평균 2-5개)
    "medium_turnover": {
        "min_daily_avg": 2.0,
        "multiplier": 1.0,  # 1.0배 (매일발주+익일배송으로 충분)
        "categories": ["050", "044", "040", "032"],  # 소주, 탄산, 기능음료, 면류
    },
    # 저회전 상품 (일평균 2개 미만): 재고 최소화
    "low_turnover": {
        "min_daily_avg": 0.0,
        "multiplier": 0.5,  # 0.5배 (저회전은 재고 부담 최소화)
        "categories": [],  # 나머지 전부
    },
}

# 카테고리별 고정 안전재고 (유통기한/회전율 무시)
CATEGORY_FIXED_SAFETY_DAYS = {
    "072": 2.0,  # 담배: 2일치 (기본값, 동적 패턴으로 추가 조정)
}


# =============================================================================
# 발주량 조정 규칙
# =============================================================================
ORDER_ADJUSTMENT_RULES = {
    # 요일별 추가 조정 (특수 케이스)
    "friday_boost": {
        "enabled": True,
        "categories": ["049", "050", "073"],  # 맥주, 소주, 전자담배
        "boost_rate": 1.15,  # 금요일 15% 추가 발주
    },

    # 폐기 방지 규칙
    "disuse_prevention": {
        "enabled": True,
        "shelf_life_threshold": 3,  # 유통기한 3일 이하
        "reduction_rate": 0.85,     # 15% 감량 발주
    },

    # 재고 과다 방지
    "overstock_prevention": {
        "enabled": True,
        "stock_days_threshold": 5,  # 5일치 이상 재고 시
        "skip_order": True,         # 발주 스킵
    },
}


# =============================================================================
# 카테고리 매핑 (mid_cd -> 한글명)
# =============================================================================
CATEGORY_NAMES = {
    # 기존
    "001": "도시락", "002": "주먹밥", "003": "김밥", "004": "샌드위치류",
    "005": "햄버거", "006": "조리면", "012": "빵",
    "015": "비스켓/쿠키", "016": "스낵류",
    "019": "초콜릿", "020": "캔디", "022": "마른안주류", "023": "육가공류",
    "032": "면류", "040": "기능건강음료", "041": "생수",
    "042": "커피음료", "044": "탄산음료", "047": "우유",
    "049": "맥주", "050": "소주", "051": "전통주",
    "060": "홈/주방용품", "072": "담배", "073": "전자담배",
    "605": "기타주류", "900": "소모품",
    # 소멸성
    "013": "떡", "026": "과일/채소", "046": "요구르트",
    # 음료류
    "010": "제조음료", "039": "과일야채음료", "043": "차음료",
    "045": "아이스드링크", "048": "얼음",
    # 냉동/아이스크림
    "021": "일반아이스크림", "034": "냉동즉석식", "100": "RI아이스크림",
    # 즉석식품
    "014": "디저트", "017": "시리얼", "027": "농산식재료",
    "028": "축수산식재료", "029": "조미료류", "030": "커피차류",
    "031": "반찬류", "033": "상온즉석식", "035": "냉장즉석식",
    # 과자/간식
    "018": "껌",
    # 일반주류
    "052": "양주", "053": "와인",
    # 생활용품
    "036": "의약외품", "037": "건강기능", "056": "목욕세면",
    "057": "위생용품", "086": "안전상비의약품",
    # 잡화/비식품
    "054": "음료선물세트", "055": "화장품", "058": "의류용품",
    "059": "액세서리", "061": "문구류", "062": "전기연료",
    "063": "우천용상품", "064": "완구류", "066": "파티/오락용품",
    "067": "애완용품", "068": "입지특화상품", "069": "소형가전",
    "070": "상품권", "071": "편의상품",
}


@dataclass
class DefaultPatternResult:
    """일반 상품 패턴 분석 결과"""
    item_cd: str
    mid_cd: str
    daily_avg: float              # 일평균 판매량
    expiration_days: Optional[int]  # 유통기한 (일)
    shelf_group: str              # 유통기한 그룹
    safety_days: float            # 안전재고 일수
    safety_stock: float           # 안전재고 수량
    turnover_multiplier: float    # 회전율 배수


def get_shelf_life_group(expiration_days: Optional[int]) -> str:
    """유통기한 일수로 그룹 반환

    Args:
        expiration_days: 유통기한 일수 (None이면 ultra_long)

    Returns:
        유통기한 그룹명 (ultra_short, short, medium, long, ultra_long)
    """
    if expiration_days is None:
        return "ultra_long"  # 정보 없으면 장기로 취급

    for group, cfg in SHELF_LIFE_CONFIG.items():
        if cfg["min_days"] <= expiration_days <= cfg["max_days"]:
            return group
    return "ultra_long"


def get_weekday_coefficient(mid_cd: str, weekday: int) -> float:
    """카테고리와 요일로 계수 반환

    Args:
        mid_cd: 중분류 코드
        weekday: 요일 번호 (0=일, 1=월, ..., 6=토)

    Returns:
        요일 계수 (1.0 = 평균, >1.0 = 증가, <1.0 = 감소)
    """
    if mid_cd in WEEKDAY_COEFFICIENTS:
        return WEEKDAY_COEFFICIENTS[mid_cd][weekday]
    return DEFAULT_WEEKDAY_COEFFICIENTS[weekday]


def get_safety_stock_days(
    mid_cd: str,
    daily_avg: float,
    expiration_days: Optional[int]
) -> float:
    """
    안전재고 일수 계산 (기본)

    Args:
        mid_cd: 중분류 코드
        daily_avg: 일평균 판매량
        expiration_days: 유통기한 일수

    Returns:
        안전재고 일수
    """
    # 1. 카테고리별 고정값 우선 (담배 등)
    if mid_cd in CATEGORY_FIXED_SAFETY_DAYS:
        return CATEGORY_FIXED_SAFETY_DAYS[mid_cd]

    # 2. 유통기한 기반 기본값
    shelf_group = get_shelf_life_group(expiration_days)
    base_days = SHELF_LIFE_CONFIG[shelf_group]["safety_stock_days"]

    # 3. 회전율 기반 조정
    if daily_avg >= 5.0:
        multiplier = SAFETY_STOCK_MULTIPLIER["high_turnover"]["multiplier"]
    elif daily_avg >= 2.0:
        multiplier = SAFETY_STOCK_MULTIPLIER["medium_turnover"]["multiplier"]
    else:
        multiplier = SAFETY_STOCK_MULTIPLIER["low_turnover"]["multiplier"]

    return base_days * multiplier


def analyze_default_pattern(
    item_cd: str,
    mid_cd: str,
    daily_avg: float,
    expiration_days: Optional[int] = None
) -> DefaultPatternResult:
    """
    일반 상품 패턴 분석

    Args:
        item_cd: 상품코드
        mid_cd: 중분류 코드
        daily_avg: 일평균 판매량
        expiration_days: 유통기한 일수

    Returns:
        DefaultPatternResult
    """
    # 유통기한 그룹
    shelf_group = get_shelf_life_group(expiration_days)

    # 안전재고 일수
    safety_days = get_safety_stock_days(mid_cd, daily_avg, expiration_days)

    # 회전율 배수
    if daily_avg >= 5.0:
        turnover_multiplier = SAFETY_STOCK_MULTIPLIER["high_turnover"]["multiplier"]
    elif daily_avg >= 2.0:
        turnover_multiplier = SAFETY_STOCK_MULTIPLIER["medium_turnover"]["multiplier"]
    else:
        turnover_multiplier = SAFETY_STOCK_MULTIPLIER["low_turnover"]["multiplier"]

    # 안전재고 수량
    safety_stock = daily_avg * safety_days

    return DefaultPatternResult(
        item_cd=item_cd,
        mid_cd=mid_cd,
        daily_avg=round(daily_avg, 2),
        expiration_days=expiration_days,
        shelf_group=shelf_group,
        safety_days=round(safety_days, 2),
        safety_stock=round(safety_stock, 2),
        turnover_multiplier=turnover_multiplier
    )
