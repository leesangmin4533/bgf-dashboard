<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGF 발주 시스템</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=14">
    <script>
        /* FOUC 방지: 페이지 로드 전 저장된 테마 즉시 적용 */
        (function() {
            var saved = localStorage.getItem('bgf-theme');
            if (saved) document.documentElement.setAttribute('data-theme', saved);
            else document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
</head>
<body>
    <!-- 상단 네비게이션 -->
    <nav class="top-nav">
        <div class="nav-brand">BGF 발주 시스템</div>
        <div class="nav-tabs">
            <a href="#" class="nav-tab active" data-tab="home">홈</a>
            <a href="#" class="nav-tab" data-tab="prediction">예측분석</a>
            <a href="#" class="nav-tab" data-tab="order">발주</a>
            <a href="#" class="nav-tab" data-tab="report">리포트</a>
            <a href="#" class="nav-tab" data-tab="rules">규칙 현황판</a>
            <a href="#" class="nav-tab" data-tab="users" id="navTabUsers" style="display:none">사용자 관리</a>
        </div>
        <div class="nav-right">
            <!-- 사용자 정보 -->
            <div class="nav-user-info" id="navUserInfo" style="display:none;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span id="navUsername" style="font-size:0.85rem;font-weight:500;"></span>
                <span id="navStoreBadge" style="font-size:0.7rem;background:rgba(99,102,241,0.2);color:#a5b4fc;padding:2px 8px;border-radius:6px;margin-left:4px;"></span>
            </div>
            <!-- 매장 선택 (admin만) -->
            <div class="nav-store-picker" id="navStorePicker">
                <svg class="nav-store-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <select id="globalStoreSelect" class="nav-store-select">
                    <option value="">로딩중...</option>
                </select>
            </div>
            <div class="nav-status" id="serverStatus">● 연결됨</div>
            <button class="theme-toggle" id="themeToggle" title="테마 전환" aria-label="테마 전환">
                <div class="theme-toggle-knob">
                    <svg id="themeIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/>
                    </svg>
                </div>
            </button>
            <!-- 로그아웃 -->
            <button class="theme-toggle" id="btnLogout" title="로그아웃" aria-label="로그아웃" style="margin-left:4px;">
                <div class="theme-toggle-knob">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </div>
            </button>
        </div>
    </nav>

    <!-- =============================== -->
    <!-- =============================== -->
    <!-- 홈 탭                             -->
    <!-- =============================== -->
    <main id="tab-home" class="tab-content active">

        <!-- 메인 메트릭 카드 (Bento Grid) -->
        <div class="home-bento">
            <!-- 스케줄러 카드 -->
            <div class="metric-card metric-primary" id="homeCardScheduler" onclick="openSchedulerModal()">
                <div class="metric-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="metric-body">
                    <div class="metric-label">스케줄러</div>
                    <div class="metric-value" id="homeSchedulerValue">확인중</div>
                    <div class="metric-sub" id="homeSchedulerSub"></div>
                </div>
            </div>

            <!-- 발주 현황 카드 -->
            <div class="metric-card metric-success" id="homeCardOrder">
                <div class="metric-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                        <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="metric-body">
                    <div class="metric-label" id="homeOrderLabel">오늘 발주</div>
                    <div class="metric-value" id="homeOrderValue">-</div>
                    <div class="metric-sub" id="homeOrderSub"></div>
                    <div class="metric-spark" id="homeOrderSpark"></div>
                </div>
            </div>

            <!-- 폐기 위험 카드 -->
            <div class="metric-card metric-danger" id="homeCardExpiry" onclick="openExpiryModal()">
                <div class="metric-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="metric-body">
                    <div class="metric-label">폐기 위험</div>
                    <div class="metric-value" id="homeExpiryValue">0</div>
                    <div class="metric-sub" id="homeExpirySub"></div>
                </div>
            </div>

        </div>

        <!-- 파이프라인 상태 + 최근 이벤트 -->
        <div class="home-grid-2col">
            <!-- 파이프라인 상태 -->
            <div class="home-panel">
                <div class="home-panel-header">
                    <h3 class="home-panel-title">파이프라인 상태</h3>
                </div>
                <div class="home-panel-body" id="homePipelineBody">
                    <div class="pipeline-steps">
                        <div class="pipeline-step" id="pipeCollect">
                            <div class="pipeline-dot"></div>
                            <div class="pipeline-info">
                                <div class="pipeline-name">데이터 수집</div>
                                <div class="pipeline-time" id="pipeCollectTime">-</div>
                            </div>
                        </div>
                        <div class="pipeline-connector"></div>
                        <div class="pipeline-step" id="pipePrediction">
                            <div class="pipeline-dot"></div>
                            <div class="pipeline-info">
                                <div class="pipeline-name">예측</div>
                                <div class="pipeline-time" id="pipePredictionTime">-</div>
                            </div>
                        </div>
                        <div class="pipeline-connector"></div>
                        <div class="pipeline-step" id="pipeOrder">
                            <div class="pipeline-dot"></div>
                            <div class="pipeline-info">
                                <div class="pipeline-name">발주</div>
                                <div class="pipeline-time" id="pipeOrderTime">-</div>
                            </div>
                        </div>
                        <div class="pipeline-connector"></div>
                        <div class="pipeline-step" id="pipeEval">
                            <div class="pipeline-dot"></div>
                            <div class="pipeline-info">
                                <div class="pipeline-name">평가</div>
                                <div class="pipeline-time" id="pipeEvalTime">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 최근 이벤트 -->
            <div class="home-panel">
                <div class="home-panel-header">
                    <h3 class="home-panel-title">최근 이벤트</h3>
                </div>
                <div class="home-panel-body" id="homeEventsBody">
                    <div class="hint">로딩중...</div>
                </div>
            </div>
        </div>

        <!-- 가입 요청 (admin only) -->
        <div class="home-panel" id="homeSignupPanel" data-admin-only style="display:none">
            <div class="home-panel-header">
                <h3 class="home-panel-title">가입 요청</h3>
                <span class="home-panel-badge" id="homeSignupCount">0</span>
            </div>
            <div class="home-panel-body">
                <div class="report-table-wrapper">
                    <table class="report-table" id="homeSignupTable">
                        <thead>
                            <tr>
                                <th data-sort="text">매장 코드</th>
                                <th data-sort="text">핸드폰</th>
                                <th data-sort="text">요청일</th>
                                <th>처리</th>
                            </tr>
                        </thead>
                        <tbody id="homeSignupTableBody"></tbody>
                    </table>
                </div>
                <div class="hint" id="homeSignupEmpty" style="display:none">대기 중인 가입 요청이 없습니다.</div>
            </div>
        </div>

        <!-- 발주 실패 사유 -->
        <div class="home-panel" id="homeFailPanel" style="display:none">
            <div class="home-panel-header">
                <h3 class="home-panel-title">오늘 발주 실패 사유</h3>
                <span class="home-panel-badge" id="homeFailCount">0</span>
            </div>
            <div class="home-panel-body">
                <div class="report-table-wrapper">
                    <table class="report-table" id="homeFailTable">
                        <thead>
                            <tr>
                                <th data-sort="text">상품명</th>
                                <th data-sort="text">카테고리</th>
                                <th data-sort="text">사유</th>
                                <th data-sort="text">상태</th>
                            </tr>
                        </thead>
                        <tbody id="homeFailTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- =============================== -->
    <!-- 예측분석 탭                       -->
    <!-- =============================== -->
    <main id="tab-prediction" class="tab-content">

        <!-- 요약 카드 4개 -->
        <div class="pred-summary-grid">
            <div class="pred-summary-card pred-card-info" id="predHitRate">
                <div class="pred-card-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="pred-card-body">
                    <div class="pred-card-label">예측 적중률</div>
                    <div class="pred-card-value" id="predHitRateValue">-</div>
                    <div class="pred-card-sub" id="predHitRateSub"></div>
                </div>
            </div>

            <div class="pred-summary-card pred-card-success" id="predQtyAccuracy">
                <div class="pred-card-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="pred-card-body">
                    <div class="pred-card-label">정량 정확도</div>
                    <div class="pred-card-value" id="predQtyAccuracyValue">-</div>
                    <div class="pred-card-sub" id="predQtyAccuracySub"></div>
                </div>
            </div>

            <div class="pred-summary-card pred-card-accent" id="predMLStatus">
                <div class="pred-card-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="pred-card-body">
                    <div class="pred-card-label">ML 모델</div>
                    <div class="pred-card-value" id="predMLStatusValue">-</div>
                    <div class="pred-card-sub" id="predMLStatusSub"></div>
                </div>
            </div>

            <div class="pred-summary-card pred-card-warning" id="predModelMix">
                <div class="pred-card-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <path d="M18 20V10M12 20V4M6 20v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="pred-card-body">
                    <div class="pred-card-label">예측 방식 비율</div>
                    <div class="pred-card-value" id="predModelMixValue">-</div>
                    <div class="pred-card-sub" id="predModelMixSub"></div>
                </div>
            </div>
        </div>

        <!-- 서브탭 선택기 -->
        <div class="pred-type-selector">
            <button class="pred-type-btn active" data-pred-view="accuracy">적중률 상세</button>
            <button class="pred-type-btn" data-pred-view="ml">ML 모델</button>
            <button class="pred-type-btn" data-pred-view="blending">예측 비중</button>
        </div>

        <!-- 서브뷰 1: 적중률 상세 -->
        <div id="pred-view-accuracy" class="pred-view active">
            <div class="report-chart-card full-width">
                <div class="chart-card-header">
                    <h3 class="chart-title">일별 MAPE 추이 (14일)</h3>
                </div>
                <div class="chart-card-body">
                    <canvas id="predMapeChart" height="250"></canvas>
                </div>
            </div>

            <div class="report-charts-grid">
                <div class="report-table-card">
                    <div class="table-card-header">
                        <h3 class="chart-title">카테고리별 정확도</h3>
                    </div>
                    <div class="table-card-body">
                        <div class="report-table-wrapper">
                            <table class="report-table" id="predCategoryTable">
                                <thead>
                                    <tr>
                                        <th data-sort="text">카테고리</th>
                                        <th data-sort="num" class="text-right">MAPE</th>
                                        <th data-sort="num" class="text-right">MAE</th>
                                        <th data-sort="num" class="text-right">+-2 적중</th>
                                        <th data-sort="num" class="text-right">건수</th>
                                    </tr>
                                </thead>
                                <tbody id="predCategoryTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="report-table-card">
                    <div class="table-card-header">
                        <h3 class="chart-title">Best / Worst 상품</h3>
                    </div>
                    <div class="table-card-body" id="predBestWorstBody">
                        <div class="hint">데이터 로딩중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 서브뷰 2: ML 모델 -->
        <div id="pred-view-ml" class="pred-view">
            <div class="pred-ml-grid" id="predMLGrid">
                <div class="hint">ML 모델 정보 로딩중...</div>
            </div>
        </div>

        <!-- 서브뷰 3: 예측 비중 -->
        <div id="pred-view-blending" class="pred-view">
            <div class="report-charts-grid">
                <div class="report-chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-title">블렌딩 규칙</h3>
                    </div>
                    <div class="chart-card-body" id="predBlendDiagram"></div>
                </div>

                <div class="report-chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-title">예측 방식 분포 (7일)</h3>
                    </div>
                    <div class="chart-card-body">
                        <canvas id="predDonutChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <div class="report-charts-grid">
                <div class="report-table-card">
                    <div class="table-card-header">
                        <h3 class="chart-title">EvalConfig 파라미터</h3>
                    </div>
                    <div class="table-card-body">
                        <div class="report-table-wrapper">
                            <table class="report-table" id="predEvalConfigTable">
                                <thead>
                                    <tr>
                                        <th data-sort="text">파라미터</th>
                                        <th data-sort="num" class="text-right">현재값</th>
                                        <th data-sort="num" class="text-right">기본값</th>
                                        <th data-sort="text">설명</th>
                                    </tr>
                                </thead>
                                <tbody id="predEvalConfigBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="report-table-card">
                    <div class="table-card-header">
                        <h3 class="chart-title">보정 이력</h3>
                    </div>
                    <div class="table-card-body">
                        <div class="report-table-wrapper">
                            <table class="report-table" id="predCalibrationTable">
                                <thead>
                                    <tr>
                                        <th data-sort="text">날짜</th>
                                        <th data-sort="text">파라미터</th>
                                        <th data-sort="num" class="text-right">이전</th>
                                        <th data-sort="num" class="text-right">변경</th>
                                        <th data-sort="text">사유</th>
                                    </tr>
                                </thead>
                                <tbody id="predCalibrationBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- =============================== -->
    <!-- 발주 탭                          -->
    <!-- =============================== -->
    <!-- =============================== -->
    <!-- 발주 탭                          -->
    <!-- =============================== -->
    <main id="tab-order" class="tab-content">

        <div class="order-container">
            <!-- 발주 모드 선택 -->
            <div class="order-mode-selector">
                <button class="order-mode-btn active" data-mode="partial" id="btnModePartial">
                    <svg class="mode-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="5" width="18" height="4" rx="1"/>
                        <rect x="3" y="10" width="18" height="4" rx="1"/>
                        <rect x="3" y="15" width="18" height="4" rx="1"/>
                    </svg>
                    <span class="mode-label">부분발주</span>
                    <span class="mode-desc">카테고리 선택</span>
                </button>
                <button class="order-mode-btn" data-mode="full" id="btnModeFull">
                    <svg class="mode-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <polyline points="9 11 12 14 16 10"/>
                    </svg>
                    <span class="mode-label">전체발주</span>
                    <span class="mode-desc">전체 상품</span>
                </button>
            </div>

            <!-- 부분발주 섹션 -->
            <div class="order-section" id="sectionPartial" style="display:block">
                <div class="order-section-header">
                    <div>
                        <h2 class="section-title">카테고리 선택</h2>
                        <p class="section-desc">발주할 카테고리를 선택하세요</p>
                    </div>
                    <label class="select-all-label">
                        <input type="checkbox" id="partialSelectAll" checked>
                        <span>전체 선택</span>
                    </label>
                </div>

                <div class="category-grid" id="partialCategoryGrid">
                    <div class="hint">카테고리 로딩중...</div>
                </div>

                <div class="order-summary-card" id="partialSummary">
                    <div class="summary-stat">
                        <div class="summary-label">선택 카테고리</div>
                        <div class="summary-value"><span id="partialCatCount">0</span>개</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-label">예상 상품수</div>
                        <div class="summary-value" id="partialItemCount">-</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-label">예상 발주량</div>
                        <div class="summary-value" id="partialQtyTotal">-</div>
                    </div>
                </div>

                <div id="partialStatus" class="status-text order-status-bar"></div>

                <div class="order-action-buttons">
                    <button class="btn-order btn-order-preview" id="btnPartialPreview">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <span>미리보기</span>
                    </button>
                    <button class="btn-order btn-order-excel" id="btnPartialExcel" onclick="exportPreviewExcel()" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span>엑셀 다운로드</span>
                    </button>
                    <button class="btn-order btn-order-execute" id="btnPartialExecute">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 11 12 14 22 4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        <span>발주 실행</span>
                    </button>
                </div>
            </div>

            <!-- 전체발주 섹션 -->
            <div class="order-section" id="sectionFull" style="display:none">
                <div class="order-section-header">
                    <div>
                        <h2 class="section-title">전체 상품 발주</h2>
                        <p class="section-desc">모든 카테고리의 상품을 한 번에 발주합니다</p>
                    </div>
                </div>

                <div class="full-order-info">
                    <div class="info-card">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4m0-4h.01"/>
                        </svg>
                        <div class="info-content">
                            <div class="info-title">전체 발주 정보</div>
                            <ul class="info-list">
                                <li>모든 카테고리의 상품이 대상입니다</li>
                                <li>안전재고 기반 자동 계산이 적용됩니다</li>
                                <li>발주 제외 상품은 자동으로 제외됩니다</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <details class="exclude-panel" id="excludePanel">
                    <summary class="exclude-panel-summary">
                        발주 제외 상품 (<span id="excludeTotalCount">0</span>건)
                        <span class="exclude-store-badge">점포: <span id="excludeStoreId">-</span></span>
                    </summary>
                    <div class="exclude-panel-body">
                        <div class="exclude-group">
                            <div class="exclude-group-header">
                                <label class="exclude-toggle">
                                    <input type="checkbox" id="chkAutoOrder" checked>
                                    <span>자동발주 제외</span>
                                </label>
                                <span class="exclude-count" id="autoOrderCount">0건</span>
                                <span class="exclude-updated" id="autoOrderInfo">-</span>
                            </div>
                            <div class="exclude-items" id="autoOrderItems"></div>
                        </div>
                        <div class="exclude-group">
                            <div class="exclude-group-header">
                                <label class="exclude-toggle">
                                    <input type="checkbox" id="chkSmartOrder" checked>
                                    <span>스마트발주 제외</span>
                                </label>
                                <span class="exclude-count" id="smartOrderCount">0건</span>
                                <span class="exclude-updated" id="smartOrderInfo">-</span>
                            </div>
                            <div class="exclude-items" id="smartOrderItems"></div>
                        </div>
                    </div>
                </details>

                <div class="order-action-buttons">
                    <button class="btn-order btn-order-preview" id="btnFullPreview">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <span>미리보기</span>
                    </button>
                    <button class="btn-order btn-order-excel" id="btnFullExcel" onclick="exportPreviewExcel()" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span>엑셀 다운로드</span>
                    </button>
                    <button class="btn-order btn-order-execute" id="btnFullExecute">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 11 12 14 22 4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        <span>발주 실행</span>
                    </button>
                </div>
            </div>

            <!-- 공통 설정 및 로그 영역 -->
            <div class="order-log-section">
                <div class="order-settings">
                    <div class="order-settings-row">
                        <div class="order-setting-field">
                            <label class="order-setting-label">최대 상품수</label>
                            <input type="number" id="testMaxItems" value="10" min="0" class="order-setting-input">
                        </div>
                        <div class="order-setting-field">
                            <label class="order-setting-label">최소 발주량</label>
                            <input type="number" id="testMinQty" value="0" min="0" class="order-setting-input">
                        </div>
                        <div class="order-setting-actions">
                            <button id="btnStopScript" class="btn btn-danger" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon-sm">
                                    <rect x="6" y="6" width="12" height="12"/>
                                </svg>
                                <span>중지</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="order-log-container">
                    <div class="order-log-header">
                        <h3 class="order-log-title">실행 로그</h3>
                        <div class="order-log-controls">
                            <span id="scriptElapsed" class="order-log-elapsed"></span>
                            <button onclick="document.getElementById('scriptLog').textContent = ''; document.getElementById('scriptElapsed').textContent = '';" class="btn btn-sm">
                                로그 지우기
                            </button>
                        </div>
                    </div>
                    <pre id="scriptLog" class="order-log-output"></pre>
                </div>
            </div>
        </div>

    </main>

    <!-- =============================== -->
    <!-- 리포트 탭                         -->
    <!-- =============================== -->
    <main id="tab-report" class="tab-content">

        <div class="report-container">
            <!-- 리포트 타입 선택 -->
            <div class="report-type-selector">
                <button class="report-type-btn active" data-report="daily">
                    <svg class="report-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span class="report-label">일일 리포트</span>
                    <span class="report-desc">오늘의 발주 현황</span>
                </button>
                <button class="report-type-btn" data-report="weekly">
                    <svg class="report-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    <span class="report-label">주간 트렌드</span>
                    <span class="report-desc">7일 판매 분석</span>
                </button>
                <button class="report-type-btn" data-report="category">
                    <svg class="report-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
                    </svg>
                    <span class="report-label">카테고리 분석</span>
                    <span class="report-desc">품목별 상세</span>
                </button>
                <button class="report-type-btn" data-report="impact">
                    <svg class="report-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10M12 20V4M6 20v-6"/>
                    </svg>
                    <span class="report-label">영향도 분석</span>
                    <span class="report-desc">파라미터 변경 영향</span>
                </button>
            </div>

            <!-- 일일 발주 리포트 -->
            <div id="report-daily" class="report-view active">
                <div class="report-summary-cards" id="dailySummaryCards"></div>

                <div class="report-charts-grid">
                    <div class="report-chart-card">
                        <div class="chart-card-header">
                            <h3 class="chart-title">카테고리별 발주량</h3>
                        </div>
                        <div class="chart-card-body">
                            <canvas id="dailyCategoryChart"></canvas>
                        </div>
                    </div>

                    <div class="report-chart-card">
                        <div class="chart-card-header">
                            <h3 class="chart-title">안전재고 일수 분포</h3>
                        </div>
                        <div class="chart-card-body">
                            <canvas id="dailySafetyHist" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <div class="report-table-card" id="dailyTablePanel">
                    <div class="table-card-header">
                        <h3 class="chart-title">상품별 상세</h3>
                        <input type="text" id="dailySearch" class="report-search" placeholder="상품명, 카테고리 검색...">
                    </div>
                    <div class="table-card-body">
                        <div class="report-table-wrapper">
                            <table id="dailyTable" class="report-table">
                                <thead>
                                    <tr>
                                        <th data-sort="text">상품명</th>
                                        <th data-sort="text">카테고리</th>
                                        <th data-sort="num" class="text-right">일평균</th>
                                        <th data-sort="num" class="text-right">안전재고</th>
                                        <th data-sort="num" class="text-right">현재고</th>
                                        <th data-sort="num" class="text-right">발주량</th>
                                        <th data-sort="text" class="text-center">신뢰도</th>
                                    </tr>
                                </thead>
                                <tbody id="dailyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 주간 트렌드 리포트 -->
            <div id="report-weekly" class="report-view">
                <div class="report-summary-cards" id="weeklySummaryCards"></div>

                <div class="report-chart-card full-width">
                    <div class="chart-card-header">
                        <h3 class="chart-title">카테고리별 판매 추이</h3>
                    </div>
                    <div class="chart-card-body">
                        <canvas id="weeklyTrendChart" height="300"></canvas>
                    </div>
                </div>

                <div class="report-charts-grid">
                    <div class="report-chart-card">
                        <div class="chart-card-header">
                            <h3 class="chart-title">예측 정확도</h3>
                        </div>
                        <div class="chart-card-body">
                            <canvas id="weeklyAccuracyChart" height="250"></canvas>
                        </div>
                    </div>

                    <div class="report-chart-card">
                        <div class="chart-card-header">
                            <h3 class="chart-title">요일별 판매 패턴</h3>
                        </div>
                        <div class="chart-card-body">
                            <div id="weeklyHeatmap"></div>
                        </div>
                    </div>
                </div>

                <div class="report-table-card">
                    <div class="table-card-header">
                        <h3 class="chart-title">판매 상위 TOP 10</h3>
                    </div>
                    <div class="table-card-body">
                        <div id="weeklyTopItems"></div>
                    </div>
                </div>
            </div>

            <!-- 카테고리 분석 리포트 -->
            <div id="report-category" class="report-view">
                <div class="category-selector-card">
                    <label class="category-label">카테고리 선택</label>
                    <div class="category-selector-controls">
                        <select id="categorySelect" class="category-select"></select>
                        <button id="btnLoadCategory" class="btn-analyze">분석 시작</button>
                    </div>
                </div>

                <div id="categoryContent" style="display:none">
                    <div class="report-summary-cards" id="catSummaryCards"></div>

                    <div class="report-chart-card full-width">
                        <div class="chart-card-header">
                            <h3 class="chart-title">요일 계수 비교</h3>
                        </div>
                        <div class="chart-card-body">
                            <canvas id="catRadarChart" height="280"></canvas>
                        </div>
                    </div>

                    <div class="report-charts-grid">
                        <div class="report-chart-card">
                            <div class="chart-card-header">
                                <h3 class="chart-title">회전율 분포</h3>
                            </div>
                            <div class="chart-card-body">
                                <canvas id="catDoughnutChart"></canvas>
                            </div>
                        </div>

                        <div class="report-chart-card">
                            <div class="chart-card-header">
                                <h3 class="chart-title">안전재고 설정</h3>
                            </div>
                            <div class="chart-card-body">
                                <div id="catSafetyTable"></div>
                            </div>
                        </div>
                    </div>

                    <div class="report-table-card">
                        <div class="table-card-header">
                            <h3 class="chart-title">상품별 7일 추이</h3>
                        </div>
                        <div class="table-card-body">
                            <div id="catSparklines"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 영향도 분석 리포트 -->
            <div id="report-impact" class="report-view">
                <div class="report-chart-card impact-header-card">
                    <div class="chart-card-header impact-header-flex">
                        <h3 class="chart-title">안전재고 파라미터 영향도 분석</h3>
                        <div class="impact-actions">
                            <span id="baselineStatus" class="status-text impact-status"></span>
                            <button id="btnSaveBaseline" class="btn btn-sm">Baseline 저장</button>
                            <button id="btnLoadImpact" class="btn-analyze btn-sm">영향도 분석</button>
                        </div>
                    </div>
                </div>

                <div id="impactContent" style="display: none;">
                    <div class="report-summary-cards" id="impactSummaryCards"></div>

                    <div class="report-chart-card full-width">
                        <div class="chart-card-header">
                            <h3 class="chart-title">카테고리별 변화율</h3>
                        </div>
                        <div class="chart-card-body">
                            <canvas id="impactCatChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="report-table-card">
                        <div class="table-card-header">
                            <h3 class="chart-title">상품별 비교</h3>
                            <input type="text" id="impactSearch" class="report-search" placeholder="상품명, 카테고리 검색...">
                        </div>
                        <div class="table-card-body">
                            <div id="impactTable"></div>
                        </div>
                    </div>

                    <div class="report-chart-card full-width">
                        <div class="chart-card-header">
                            <h3 class="chart-title">품절 추이</h3>
                        </div>
                        <div class="chart-card-body">
                            <canvas id="impactStockoutChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- =============================== -->
    <!-- 규칙 현황판 탭                     -->
    <!-- =============================== -->
    <main id="tab-rules" class="tab-content">

        <!-- 요약 카드 -->
        <div class="rules-summary-grid">
            <div class="rules-summary-card rules-card-total">
                <div class="rules-card-icon">📋</div>
                <div class="rules-card-body">
                    <div class="rules-card-value" id="rulesTotalCount">-</div>
                    <div class="rules-card-label">전체 규칙</div>
                </div>
            </div>
            <div class="rules-summary-card rules-card-active">
                <div class="rules-card-icon">✅</div>
                <div class="rules-card-body">
                    <div class="rules-card-value" id="rulesActiveCount">-</div>
                    <div class="rules-card-label">활성</div>
                </div>
            </div>
            <div class="rules-summary-card rules-card-inactive">
                <div class="rules-card-icon">⏸️</div>
                <div class="rules-card-body">
                    <div class="rules-card-value" id="rulesInactiveCount">-</div>
                    <div class="rules-card-label">비활성</div>
                </div>
            </div>
            <div class="rules-summary-card rules-card-groups">
                <div class="rules-card-icon">📁</div>
                <div class="rules-card-body">
                    <div class="rules-card-value" id="rulesGroupCount">-</div>
                    <div class="rules-card-label">그룹</div>
                </div>
            </div>
        </div>

        <!-- 상품별 규칙 추적 -->
        <div class="rules-trace-card">
            <div class="rules-trace-header">
                <h3 class="rules-trace-title">상품별 규칙 적용 추적</h3>
                <div class="rules-trace-controls">
                    <input type="text" id="rulesTraceInput" class="rules-trace-input" placeholder="상품코드 입력 (예: 8801234567890)">
                    <button id="btnRulesTrace" class="rules-trace-btn">조회</button>
                </div>
            </div>
            <div id="rulesTraceResult" class="rules-trace-result" style="display:none"></div>
        </div>

        <!-- 그룹별 규칙 목록 -->
        <div id="rulesGroupContainer" class="rules-group-container"></div>

    </main>

    <!-- =============================== -->
    <!-- 사용자 관리 탭 (admin 전용)          -->
    <!-- =============================== -->
    <main id="tab-users" class="tab-content">

        <!-- 가입 요청 섹션 -->
        <div class="home-panel" id="usersSignupPanel">
            <div class="home-panel-header">
                <h3 class="home-panel-title">가입 요청 대기</h3>
                <span class="home-panel-badge" id="usersSignupCount">0</span>
            </div>
            <div class="home-panel-body">
                <div class="report-table-wrapper">
                    <table class="report-table" id="usersSignupTable" style="display:none">
                        <thead>
                            <tr>
                                <th data-sort="text">매장 코드</th>
                                <th data-sort="text">핸드폰</th>
                                <th data-sort="text">요청일</th>
                                <th>처리</th>
                            </tr>
                        </thead>
                        <tbody id="usersSignupTableBody"></tbody>
                    </table>
                </div>
                <div class="hint" id="usersSignupEmpty">대기 중인 가입 요청이 없습니다.</div>
            </div>
        </div>

        <!-- 사용자 목록 섹션 -->
        <div class="home-panel">
            <div class="home-panel-header">
                <h3 class="home-panel-title">등록된 사용자</h3>
                <button class="btn-sm btn-approve" onclick="showCreateUserForm()" style="font-size:0.8rem;">+ 사용자 추가</button>
            </div>
            <div class="home-panel-body">
                <!-- 사용자 추가 인라인 폼 -->
                <div id="createUserForm" style="display:none; margin-bottom:16px; padding:16px; background:var(--bg-base); border:1px solid var(--border); border-radius:var(--radius-md);">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr auto; gap:10px; align-items:end;">
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-secondary); display:block; margin-bottom:4px;">아이디</label>
                            <input type="text" id="newUsername" placeholder="영문/숫자 3~30자" style="width:100%; padding:8px 10px; background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-size:0.85rem;">
                        </div>
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-secondary); display:block; margin-bottom:4px;">비밀번호</label>
                            <input type="password" id="newPassword" placeholder="4자 이상" style="width:100%; padding:8px 10px; background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-size:0.85rem;">
                        </div>
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-secondary); display:block; margin-bottom:4px;">매장 코드</label>
                            <input type="text" id="newStoreId" placeholder="5자리 숫자" maxlength="5" style="width:100%; padding:8px 10px; background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-size:0.85rem;">
                        </div>
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-secondary); display:block; margin-bottom:4px;">역할</label>
                            <select id="newRole" style="width:100%; padding:8px 10px; background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-size:0.85rem;">
                                <option value="viewer">viewer</option>
                                <option value="admin">admin</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button class="btn-sm btn-approve" onclick="createUser()">생성</button>
                            <button class="btn-sm btn-reject" onclick="hideCreateUserForm()">취소</button>
                        </div>
                    </div>
                </div>

                <input type="text" id="usersSearch" class="search-box" placeholder="아이디, 매장코드 검색..." style="margin-bottom:12px;">
                <div class="report-table-wrapper">
                    <table class="report-table" id="usersTable">
                        <thead>
                            <tr>
                                <th data-sort="num">ID</th>
                                <th data-sort="text">아이디</th>
                                <th data-sort="text">매장</th>
                                <th data-sort="text">역할</th>
                                <th data-sort="text">이름</th>
                                <th data-sort="text">핸드폰</th>
                                <th data-sort="text">활성</th>
                                <th data-sort="text">마지막 로그인</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- =============================== -->
    <!-- 모달                              -->
    <!-- =============================== -->

    <!-- 스케줄러 모달 -->
    <div id="schedulerModal" class="modal" onclick="closeSchedulerModal(event)">
        <div class="modal-content scheduler-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">스케줄러 관리</h2>
                <button class="modal-close" onclick="closeSchedulerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="scheduler-control-panel">
                    <div class="scheduler-status-info">
                        <span class="status-badge" id="schedulerStatusBadge">확인중</span>
                        <span class="status-text" id="schedulerPidText"></span>
                    </div>
                    <div class="scheduler-buttons">
                        <button id="btnSchedulerStart" class="btn-scheduler-start" onclick="schedulerStart()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M8 5v14l11-7z" fill="currentColor"/>
                            </svg>
                            <span>스케줄러 시작</span>
                        </button>
                        <button id="btnSchedulerStop" class="btn-scheduler-stop" onclick="schedulerStop()" style="display:none">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <rect x="6" y="6" width="12" height="12" fill="currentColor"/>
                            </svg>
                            <span>스케줄러 중지</span>
                        </button>
                    </div>
                </div>
                <div class="schedule-timeline" id="schedulerTimeline">
                    <div class="hint">로딩중...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 폐기 위험 모달 -->
    <div id="expiryModal" class="modal" onclick="closeExpiryModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">폐기 위험 상품</h2>
                <button class="modal-close" onclick="closeExpiryModal()">&times;</button>
            </div>
            <div class="modal-body" id="expiryModalBody">
                <div class="hint">로딩중...</div>
            </div>
        </div>
    </div>

    <!-- 발주 결과 모달 -->
    <div id="orderResultModal" class="modal" onclick="closeOrderResultModal(event)">
        <div class="modal-content modal-xl" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="orderResultTitle">발주 예측 결과</h2>
                <button class="modal-close" onclick="closeOrderResultModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="result-summary" id="orderResultSummary"></div>
                <input type="text" id="orderSearch" class="search-box" placeholder="상품명, 카테고리 검색...">
                <div class="result-table-wrapper">
                    <table class="result-table" id="orderTable">
                        <thead>
                            <tr>
                                <th>상품명</th>
                                <th>카테고리</th>
                                <th class="text-right">일평균</th>
                                <th class="text-right">안전재고</th>
                                <th class="text-right">현재고</th>
                                <th class="text-right">발주량</th>
                                <th class="text-center">신뢰도</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn-export-excel" id="btnExportExcel" onclick="exportPreviewExcel()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:6px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        엑셀 다운로드
                    </button>
                    <button class="btn-confirm-order" id="btnConfirmOrder">발주 확정</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 컨테이너 -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- 스크립트 -->
    <script src="{{ url_for('static', filename='js/app.js') }}?v=11"></script>
    <script src="{{ url_for('static', filename='js/order.js') }}?v=14"></script>
    <script src="{{ url_for('static', filename='js/report.js') }}?v=10"></script>
    <script src="{{ url_for('static', filename='js/prediction.js') }}?v=4"></script>
    <script src="{{ url_for('static', filename='js/home.js') }}?v=12"></script>
    <script src="{{ url_for('static', filename='js/rules.js') }}?v=3"></script>
    <script src="{{ url_for('static', filename='js/users.js') }}?v=1"></script>
</body>
</html>
