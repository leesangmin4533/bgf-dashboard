# Phase 3: 비교 모드 사용 가이드

## 📋 개요

Phase 3는 **검증 기간**으로, 단순화 방식과 복잡한 방식을 동시에 실행하여 차이를 분석합니다.
실제 발주에는 복잡한 방식 결과를 사용하므로 **안전**합니다.

**목표**: 1-2주 동안 두 방식의 차이를 분석하여 단순화 방식 적용 가능성 판단

---

## 🚀 Phase 3 활성화

### Step 1: 비교 모드 활성화

```python
# 파일: bgf_auto/src/config/constants.py

# 비교 모드 활성화
PENDING_COMPARISON_MODE = True   # False → True 변경

# 다른 플래그는 그대로 유지
USE_SIMPLIFIED_PENDING = False   # 유지 (비교 모드가 우선)
PENDING_LOOKBACK_DAYS = 3        # 유지
```

### Step 2: 시스템 재시작

```bash
# 스케줄러 재시작
python run_scheduler.py --now
```

### Step 3: 로그 확인

비교 모드가 활성화되면 다음과 같은 로그가 생성됩니다:

```bash
# 비교 통계 로그
data/logs/pending_comparison_2026-02-07.txt

# 차이 감지 로그 (시스템 로그 내)
logs/bgf_system_2026-02-07.log
```

---

## 📊 로그 분석

### 1. 비교 통계 로그

**위치**: `data/logs/pending_comparison_YYYY-MM-DD.txt`

**포함 내용**:

```
[전체 통계]
  조회 상품 수: 150개
  결과 일치: 135개 (90.0%)
  결과 불일치: 15개 (10.0%)

[차이 분석]
  복잡>단순: 8건
  단순>복잡: 7건
  최대 차이: 12개
  평균 차이: 3.5개

[패턴 분석]
  교차날짜 패턴: 3건
  다중 발주: 5건

[권장 사항]
  ✅ 일치율 90% 이상 → 단순화 방식 적용 가능
  → constants.py에서 USE_SIMPLIFIED_PENDING = True 설정
```

### 2. 실시간 차이 로그

**위치**: `logs/bgf_system_YYYY-MM-DD.log`

**예시**:

```
[WARNING] [미입고차이] 8801234567890 도시락상품: 단순=10개, 복잡=0개, 차이=-10개 (단순>복잡), 이력=7건
[INFO]   → 교차날짜 패턴 감지: 8801234567890
[INFO]   → 3일 내 2건 발주: 8801234567890
```

---

## 📈 판단 기준

### ✅ 단순화 방식 적용 가능 (Phase 4 진행)

**조건**:
- 일치율 **≥ 90%**
- 평균 차이 **< 5개**
- 교차날짜 패턴 **< 전체의 5%**

**행동**:
1. 1-2주 동안 안정적으로 위 조건 유지 확인
2. Phase 4로 진행: A/B 테스트 (50% 상품)

### ⚠️ 추가 모니터링 필요

**조건**:
- 일치율 **80-90%**
- 평균 차이 **5-10개**
- 교차날짜 패턴 **5-10%**

**행동**:
1. 1주일 더 비교 모드 유지
2. lookback_days 조정 시도 (3 → 2 or 4)
3. 재평가

### ❌ 단순화 방식 보류

**조건**:
- 일치율 **< 80%**
- 평균 차이 **> 10개**
- 교차날짜 패턴 **> 10%**

**행동**:
1. 복잡한 방식 유지
2. 비교 모드 종료 (`PENDING_COMPARISON_MODE = False`)
3. 알고리즘 개선 검토

---

## 🔍 패턴 분석

### 교차날짜 패턴

**정의**: 발주일 ≠ 입고일 (발주 다음 날 입고)

**예시**:
```
2월 7일: 발주 10개, 입고 0
2월 6일: 발주 0, 입고 10  (실제로는 2월 7일 발주 건)
```

**영향**:
- 단순화 방식: 미입고 10개 (과대평가)
- 복잡한 방식: 미입고 0개 (정확)
- 결과: 발주 건너뜀 → 품절 위험

**완화**:
- lookback_days 조정 (3 → 5)
- 또는 복잡한 방식 유지

### 다중 발주 패턴

**정의**: 3일 내 2건 이상 발주

**예시**:
```
2월 7일: 발주 5개, 미입고
2월 6일: 발주 5개, 미입고
```

**영향**:
- 단순화 방식: 미입고 5개 (과소평가)
- 복잡한 방식: 미입고 10개 (정확)
- 결과: 중복 발주 → 재고 과다

**완화**:
- "전체 합계" 옵션 추가 (향후 개선)
- 또는 복잡한 방식 유지

---

## 🛠️ 문제 해결

### Q1: 로그 파일이 생성되지 않음

**원인**: 비교 모드 비활성화 상태

**해결**:
```python
# constants.py 확인
PENDING_COMPARISON_MODE = True  # 반드시 True
```

### Q2: 차이가 너무 많이 발생함 (> 30%)

**원인**: lookback_days가 짧음

**해결**:
```python
# constants.py
PENDING_LOOKBACK_DAYS = 5  # 3 → 5로 증가
```

### Q3: 성능이 느려짐

**원인**: 두 방식 모두 실행하므로 2배 시간 소요

**해결**:
- 정상 현상 (검증 기간만 일시적)
- 필요시 max_items 제한
- Phase 4 진행 후 해결됨

### Q4: 특정 카테고리에서 차이 집중

**예시**: 푸드류(001-005)에서 차이 80%

**원인**: 짧은 유통기한으로 교차날짜 패턴 빈번

**해결**:
- 카테고리별 lookback_days 설정 고려
- 또는 해당 카테고리는 복잡한 방식 유지

---

## 📅 Phase 3 타임라인

### Week 1 (2월 10일~16일): 초기 검증

**목표**: 기본 데이터 수집

**작업**:
1. 비교 모드 활성화
2. 매일 로그 확인
3. 차이 패턴 식별

**체크포인트**:
- [ ] 일일 통계 로그 생성 확인
- [ ] 차이 발생 상품 목록 수집
- [ ] 패턴 분류 (교차날짜 vs 다중발주)

### Week 2 (2월 17일~23일): 심화 분석

**목표**: 적용 가능성 판단

**작업**:
1. 주간 통계 집계
2. 카테고리별 분석
3. 임계값 조정 테스트 (lookback_days)

**체크포인트**:
- [ ] 일치율 90% 이상 유지?
- [ ] 평균 차이 5개 미만?
- [ ] 교차날짜 패턴 < 5%?

**결정**:
- ✅ Phase 4 진행 (A/B 테스트)
- ⚠️ 1주 더 모니터링
- ❌ Phase 3 종료 (복잡한 방식 유지)

---

## 📊 데이터 수집

### 일일 체크리스트

```bash
# 1. 로그 확인
cat data/logs/pending_comparison_$(date +%Y-%m-%d).txt

# 2. 차이 발생 건수
grep "미입고차이" logs/bgf_system_*.log | wc -l

# 3. 패턴 분포
grep "교차날짜 패턴" logs/bgf_system_*.log | wc -l
grep "다중 발주" logs/bgf_system_*.log | wc -l

# 4. 최대 차이
grep "미입고차이" logs/bgf_system_*.log | sed 's/.*차이=\([+-][0-9]*\).*/\1/' | sort -n | tail -1
```

### 주간 리포트 템플릿

```
# 미입고 계산 비교 주간 리포트 (YYYY-MM-DD ~ YYYY-MM-DD)

## 요약
- 총 조회: XXX건
- 일치율: XX.X%
- 평균 차이: X.X개

## 패턴 분석
- 교차날짜: XX건 (X.X%)
- 다중 발주: XX건 (X.X%)

## 카테고리별 분석
| 카테고리 | 일치율 | 평균 차이 | 비고 |
|---------|--------|---------|------|
| 푸드(001-005) | XX% | X.X | ... |
| 주류(049-050) | XX% | X.X | ... |

## 권장 사항
- [✅/⚠️/❌] Phase 4 진행 여부
- 조정 사항: ...
```

---

## 🔄 비교 모드 종료

### 검증 완료 후

```python
# constants.py
PENDING_COMPARISON_MODE = False  # True → False 변경

# Phase 4 진행 시
USE_SIMPLIFIED_PENDING = False   # 아직 False 유지 (A/B 테스트용)

# Phase 4 건너뛰고 전체 적용 시
USE_SIMPLIFIED_PENDING = True    # True로 변경
```

---

## 📚 참조

- **구현 요약**: `/bbb/IMPLEMENTATION_SUMMARY.md`
- **사용 가이드**: `bgf_auto/PENDING_CALCULATION_GUIDE.md`
- **기술 문서**: `bgf_auto/.claude/skills/bgf-order-flow.md`
- **테스트 코드**: `bgf_auto/tests/test_pending_comparison.py`

---

**마지막 업데이트**: 2026-02-07
**Phase 3 시작 일자**: 2026-02-07 (예정)
**Phase 3 종료 목표**: 2026-02-23 (2주 후)
