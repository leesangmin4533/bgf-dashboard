# 46704 이천 동양점 - 6개월 매출 데이터 수집 가이드

## 📋 개요

BGF 리테일 사이트에서 46704 이천 동양점의 6개월 분량 중분류매출구성비 데이터를 자동으로 수집하여 DB에 저장하는 스크립트입니다.

## 🎯 주요 기능

- **자동 날짜 생성**: 오늘부터 6개월 전까지의 날짜 자동 생성
- **중복 방지**: 이미 수집된 날짜는 자동으로 제외
- **배치 처리**: 30일 단위로 나누어 안정적으로 수집
- **재시도 로직**: 실패 시 자동 재시도 (최대 3회)
- **진행 상황 추적**: 실시간 로그로 진행 상황 확인
- **통계 출력**: 수집 완료 후 통계 자동 생성

## 🚀 실행 방법

### 1. 기본 실행

```bash
cd bgf_auto
python scripts/collect_6months_dongyang.py
```

### 2. 실행 과정

1. **날짜 목록 생성**: 6개월 분량의 날짜 자동 생성
2. **미수집 확인**: DB에서 이미 수집된 날짜 확인
3. **사용자 확인**: 수집할 날짜 수와 예상 소요 시간 표시 후 진행 확인
4. **배치 수집**: 30일씩 나누어 수집
5. **결과 출력**: 성공/실패 통계 및 최종 요약

### 3. 출력 예시

```
================================================================================
46704 이천 동양점 - 6개월 매출 데이터 수집
================================================================================

[1단계] 수집 날짜 목록 생성
수집 대상: 2025-08-06 ~ 2026-02-05 (183일)

[2단계] 미수집 날짜 확인
미수집 날짜: 183일 / 전체 183일

수집할 날짜: 183일
예상 소요 시간: 약 6.1분

계속하시겠습니까? (y/n): y

[3단계] 데이터 수집 시작
총 7개 배치로 수집 시작 (배치당 최대 30일)
================================================================================

[배치 1/7] 30일 수집 중...
날짜 범위: 2025-08-06 ~ 2025-09-04
배치 1 완료: 성공 30, 실패 0
다음 배치 전 30초 대기...

...

================================================================================
📈 수집 결과
================================================================================
총 날짜: 183일
성공: 180일
실패: 3일
성공률: 98.4%
소요 시간: 7.2분

================================================================================
📊 수집 완료 통계
================================================================================
총 수집 날짜: 180일
최신 수집일: 2026-02-05
최초 수집일: 2025-08-06

✅ 데이터 수집이 완료되었습니다!
================================================================================
```

## ⚙️ 설정

스크립트 상단에서 다음 설정을 변경할 수 있습니다:

```python
# 설정
STORE_ID = "46704"          # 점포 ID (이천 동양점)
MONTHS_TO_COLLECT = 6       # 수집할 개월 수
BATCH_SIZE = 30             # 한 번에 수집할 날짜 수
```

## 📊 수집되는 데이터

각 날짜별로 다음 데이터가 수집됩니다:

- **상품 정보**: 상품코드, 상품명, 중분류 코드, 중분류명
- **판매 데이터**: 판매수량, 발주수량, 입고수량, 폐기수량, 재고수량
- **메타 데이터**: 수집 시간, 점포 ID

## 🗄️ 저장 테이블

수집된 데이터는 다음 테이블에 저장됩니다:

1. **daily_sales**: 일별 판매 데이터
2. **products**: 상품 마스터
3. **mid_categories**: 중분류 마스터
4. **realtime_inventory**: 실시간 재고 (자동 동기화)

## ⚠️ 주의사항

### 실행 전 확인사항

1. **환경변수 설정**: `.env` 파일에 BGF 로그인 정보 필수
   ```
   BGF_USER_ID=your_id
   BGF_PASSWORD=your_password
   ```

2. **네트워크 연결**: BGF 사이트 접속 가능해야 함

3. **충분한 시간**: 6개월 분량은 약 6~10분 소요

### 실패 처리

- **일부 실패**: 실패한 날짜만 다시 실행 가능 (자동으로 제외됨)
- **전체 실패**: 로그 확인 후 네트워크/로그인 정보 점검

### 데이터 중복

- 이미 수집된 날짜는 자동으로 `UPSERT`되어 최신 데이터로 업데이트됩니다.
- 중복 실행해도 안전합니다.

## 🔍 트러블슈팅

### 1. "Login failed" 오류

**원인**: BGF 로그인 정보 오류

**해결**:
```bash
# .env 파일 확인
cat .env

# 로그인 정보 업데이트
BGF_USER_ID=correct_id
BGF_PASSWORD=correct_password
```

### 2. "No matches found" 또는 데이터 없음

**원인**: BGF 사이트 변경 또는 넥사크로 접근 실패

**해결**:
1. BGF 사이트에 직접 로그인 시도
2. Chrome 드라이버 버전 확인
3. 로그 파일 확인: `logs/bgf_auto.log`

### 3. 수집이 중간에 멈춤

**원인**: 네트워크 타임아웃 또는 BGF 사이트 세션 만료

**해결**:
1. 스크립트 재실행 (미수집 날짜만 자동으로 처리됨)
2. `BATCH_SIZE`를 줄여서 재시도 (예: 20)

### 4. 메모리 부족

**원인**: 대량 데이터 처리 시 메모리 부족

**해결**:
```python
# BATCH_SIZE 줄이기
BATCH_SIZE = 15  # 기본값 30에서 15로 감소
```

## 📁 관련 파일

```
bgf_auto/
├── scripts/
│   ├── collect_6months_dongyang.py  # [메인 스크립트]
│   └── README_collect_6months.md    # [이 문서]
├── src/
│   ├── collectors/
│   │   └── sales_collector.py       # 데이터 수집 로직
│   ├── db/
│   │   ├── models.py                # DB 스키마
│   │   └── repository.py            # 데이터 저장 로직
│   └── sales_analyzer.py            # BGF 사이트 접근
├── data/
│   └── bgf_sales.db                 # SQLite DB
└── logs/
    └── bgf_auto.log                 # 실행 로그
```

## 🎓 수집 후 활용

### 1. 중분류별 통계 조회

```python
from src.db.repository import SalesRepository

repo = SalesRepository()

# 최근 30일 수집된 날짜
collected_dates = repo.get_collected_dates(days=30)
print(f"수집된 날짜: {len(collected_dates)}일")

# 미수집 날짜
missing_dates = repo.get_missing_dates(days=30)
print(f"미수집 날짜: {missing_dates}")
```

### 2. SQL 직접 조회

```bash
# DB 접속
sqlite3 data/bgf_sales.db

# 중분류별 판매 구성비 (최근 30일)
SELECT
    mid_cd,
    SUM(sale_qty) as total_qty,
    COUNT(DISTINCT sales_date) as days,
    ROUND(SUM(sale_qty) * 100.0 / (SELECT SUM(sale_qty) FROM daily_sales WHERE sales_date >= date('now', '-30 days')), 2) as ratio
FROM daily_sales
WHERE sales_date >= date('now', '-30 days')
GROUP BY mid_cd
ORDER BY total_qty DESC;
```

## 📞 문제 발생 시

1. **로그 확인**: `logs/bgf_auto.log`
2. **DB 확인**: `data/bgf_sales.db`
3. **스크린샷**: `data/screenshots/` (자동 저장)

## 📌 버전 정보

- **작성일**: 2026-02-06
- **프로젝트**: BGF 리테일 자동 발주 시스템
- **DB 스키마**: v19
- **Python**: 3.12+
